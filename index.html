<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music & Cognition Research Platform</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #c94b4b 0%, #4b134f 100%);
            color: #ffffff;
            overflow-x: hidden;
        }

        .container {
            width: 100%;
            margin: 0;
            padding: 10px 20px;
        }

        .screen {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            padding: 20px;
        }

        .hidden {
            display: none !important;
        }

        /* Header Styles */
        header {
            text-align: center;
            margin-bottom: 40px;
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            color: #ffffff;
        }

        h2 {
            font-size: 1.8em;
            margin-bottom: 20px;
            color: #ffffff;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.4);
        }

        .subtitle {
            font-size: 1.2em;
            color: #ffffff;
            margin-bottom: 30px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        /* Welcome Screen */
        .welcome-content {
            text-align: center;
            max-width: 95%;
            width: 100%;
        }

        .welcome-content p {
            font-size: 1.1em;
            line-height: 1.6;
            margin-bottom: 20px;
            color: #ffffff;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        .system-check {
            margin: 40px 0;
            padding: 30px;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .status-card {
            background: rgba(255,255,255,0.15);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            transition: transform 0.3s;
        }

        .status-card:hover {
            transform: translateY(-5px);
        }

        .status-icon {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .status-text h4 {
            margin-bottom: 5px;
            color: #fff;
        }

        .status-text span {
            color: #4ade80;
            font-weight: bold;
        }

        /* Button Styles */
        .btn {
            padding: 15px 40px;
            font-size: 1.1em;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #ff6b6b 0%, #c94b4b 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.6);
        }

        .btn-secondary {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
        }

        .btn-secondary:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Form Styles */
        .form-container {
            background: rgba(255,255,255,0.15);
            padding: 30px 40px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            width: 95%;
            max-width: none;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            margin-top: 20px;
        }

        .form-container h2 {
            margin-bottom: 10px;
        }

        .participant-form {
            margin-top: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 25px;
            margin-bottom: 20px;
        }

        .form-row-2col {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 20px;
        }

        .form-row-3col {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 25px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 0;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #ffffff;
            font-size: 0.95em;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid rgba(255,255,255,0.4);
            border-radius: 6px;
            background: rgba(255,255,255,0.25);
            color: #1a1a1a;
            font-size: 0.95em;
            transition: border-color 0.3s, background 0.3s;
            font-weight: 500;
        }

        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: rgba(0,0,0,0.5);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            background: rgba(255,255,255,0.15);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 60px;
        }

        .form-group select option {
            background: #2a5298;
            color: white;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 8px;
        }

        .checkbox-group-horizontal {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 10px;
            margin-top: 8px;
        }

        .checkbox-group-horizontal label {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            background: rgba(255,255,255,0.05);
            border-radius: 6px;
            transition: background 0.2s;
            cursor: pointer;
        }

        .checkbox-group-horizontal label:hover {
            background: rgba(255,255,255,0.1);
        }

        .checkbox-group-horizontal input[type="checkbox"] {
            margin-right: 8px;
            cursor: pointer;
        }

        .form-group small {
            display: block;
            margin-top: 5px;
            color: #888;
            font-size: 0.85em;
        }

        .checkbox-group label,
        .radio-group label {
            display: flex;
            align-items: center;
            padding: 10px;
            background: rgba(255,255,255,0.05);
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .checkbox-group label:hover,
        .radio-group label:hover {
            background: rgba(255,255,255,0.1);
        }

        .checkbox-group input,
        .radio-group input {
            margin-right: 10px;
            width: auto;
        }

        /* Test Selection */
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .test-card {
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .test-card:hover {
            background: rgba(255,255,255,0.15);
            transform: translateY(-3px);
        }

        .test-card.selected {
            border-color: #4ade80;
            background: rgba(74, 222, 128, 0.2);
        }

        .test-card h3 {
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .test-card p {
            opacity: 0.9;
            font-size: 0.95em;
        }

        /* Results Screen */
        .results-container {
            background: rgba(255,255,255,0.1);
            padding: 30px;
            border-radius: 15px;
            width: 95%;
            max-width: 900px;
        }

        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .metric-card {
            background: rgba(255,255,255,0.15);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .metric-label {
            font-size: 0.9em;
            opacity: 0.8;
            margin-bottom: 8px;
        }

        .metric-value {
            font-size: 2em;
            font-weight: bold;
            color: #4ade80;
        }

        /* Progress Bar */
        .progress-container {
            width: 100%;
            max-width: 600px;
            margin: 20px auto;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4ade80, #22c55e);
            border-radius: 10px;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        /* Info Display */
        .info-box {
            background: rgba(255,255,255,0.15);
            padding: 15px 20px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 4px solid #ff6b6b;
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
            justify-content: center;
        }

        /* Test Content Area */
        #testContent {
            width: 100%;
            min-height: 400px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            h1 {
                font-size: 2em;
            }

            .form-row,
            .form-row-3col {
                grid-template-columns: 1fr;
            }

            .test-grid {
                grid-template-columns: 1fr;
            }

            .form-container,
            .results-container {
                padding: 25px;
            }

            .checkbox-group-horizontal {
                grid-template-columns: 1fr 1fr;
            }
        }

        /* Loading Spinner */
        .loading {
            display: inline-block;
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .full-width-section {
            grid-column: 1 / -1;
        }

        /* Test Stimulus Styles */
        .fixation-point {
            font-size: 4em;
            font-weight: bold;
            color: #ffffff;
        }
        
        .stimulus-area, .stimulus-circle {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            margin: 20px auto;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.1s;
        }
        
        .stimulus-area.active {
            background: #4ade80 !important;
            box-shadow: 0 0 40px #4ade80;
        }
        
        .stimulus-circle.go {
            background: #4ade80;
            box-shadow: 0 0 40px #4ade80;
        }
        
        .stimulus-circle.nogo {
            background: #ff6b6b;
            box-shadow: 0 0 40px #ff6b6b;
        }
        
        .test-info, .instruction-box {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 10px;
            margin: 20px auto;
            max-width: 600px;
        }
        
        .trial-counter, .time-remaining {
            font-size: 1.2em;
            margin: 10px 0;
        }
        
        .stroop-word {
            font-size: 4em;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            margin: 30px 0;
        }
        
        .led-example {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: inline-block;
            margin: 0 10px;
        }
        
        .led-example.green { background: #4ade80; }
        .led-example.white { background: #ffffff; }
        .led-example.red { background: #ff6b6b; }
        
        .performance-stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
            margin: 20px 0;
        }
        
        .stat-item, .stat-group {
            background: rgba(255,255,255,0.1);
            padding: 15px 25px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #4ade80;
        }
        
        .stat-label {
            font-size: 0.9em;
            opacity: 0.8;
        }
        
        /* LED circle lit states for tests */
        .led-circle.lit {
            box-shadow: 0 0 25px currentColor !important;
        }
        
        .button-indicator.active .led-circle {
            transform: scale(1.1);
        }
        
        /* Button indicator colors when lit (for test's own indicators) */
        .button-indicator[data-button="0"] .led-circle.lit,
        .button-indicator:nth-child(1) .led-circle.lit {
            background: #4ade80 !important;
            box-shadow: 0 0 25px #4ade80 !important;
        }
        .button-indicator[data-button="1"] .led-circle.lit,
        .button-indicator:nth-child(2) .led-circle.lit {
            background: #ffffff !important;
            box-shadow: 0 0 25px #ffffff !important;
        }
        .button-indicator[data-button="2"] .led-circle.lit,
        .button-indicator:nth-child(3) .led-circle.lit {
            background: #ff6b6b !important;
            box-shadow: 0 0 25px #ff6b6b !important;
        }
        .button-indicator[data-button="3"] .led-circle.lit,
        .button-indicator:nth-child(4) .led-circle.lit {
            background: #22c55e !important;
            box-shadow: 0 0 25px #22c55e !important;
        }
        
        /* Keyboard button indicators (top bar) */
        .kb-button-indicator.active .kb-led-circle {
            transform: scale(1.1);
        }

        /* Compact music preferences */
        .music-prefs-compact {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 10px;
        }

        .music-prefs-compact label {
            padding: 6px 10px;
            font-size: 0.9em;
        }

        /* Condition selection styling */
        .condition-selection {
            margin-top: 10px;
        }

        .condition-selection label {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            background: rgba(255,255,255,0.05);
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: pointer;
        }

        .condition-selection label:hover {
            background: rgba(255,255,255,0.1);
        }

        .condition-selection input {
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <!-- Welcome Screen -->
    <div id="welcomeScreen" class="screen">
        <div class="container">
            <header>
                <h1>üéµ Music & Cognition Research Platform</h1>
                <p class="subtitle">Investigating the Effects of Music on Cognitive Performance</p>
            </header>
            
            <div class="welcome-content">
                <p>Welcome to our research study examining how different types of music affect cognitive performance and reaction time.</p>
                
                <div class="system-check">
                    <h3>System Status</h3>
                    <div class="status-grid">
                        <div class="status-card" id="hardwareStatus">
                            <div class="status-icon">üéÆ</div>
                            <div class="status-text">
                                <h4>Hardware</h4>
                                <span id="microbitStatus">Checking...</span>
                            </div>
                        </div>
                        <div class="status-card">
                            <div class="status-icon">üîä</div>
                            <div class="status-text">
                                <h4>Audio</h4>
                                <span id="audioStatus">Ready</span>
                            </div>
                        </div>
                        <div class="status-card">
                            <div class="status-icon">üíæ</div>
                            <div class="status-text">
                                <h4>Data Storage</h4>
                                <span id="storageStatus">Ready</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="button-group">
                    <button class="btn btn-primary" onclick="platform.showScreen('participantScreen')">
                        Start New Session
                    </button>
                    <button class="btn btn-secondary" onclick="platform.loadSession()">
                        Load Previous Session
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Participant Registration Screen -->
    <div id="participantScreen" class="screen hidden">
        <div class="form-container">
            <h2>Participant Information</h2>
            <div style="text-align: center; margin: 15px 0;">
                <span style="font-size: 1em; color: #FFD700; text-shadow: 1px 1px 2px rgba(0,0,0,0.4);">Participant ID:</span>
                <div id="displayParticipantId" style="font-size: 1.8em; font-weight: bold; color: #ffffff; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); font-family: 'Courier New', monospace;">P000000</div>
            </div>
            <p style="margin-bottom: 15px; color: #ffffff; font-size: 0.9em; text-shadow: 1px 1px 2px rgba(0,0,0,0.4);">Please complete all required fields marked with *</p>
            
            <form id="participantForm" class="participant-form">
                <!-- Row 1: Basic Info -->
                <div class="form-row-3col">
                    <div class="form-group">
                        <label for="ageCategory">Age Category *</label>
                        <select id="ageCategory" name="ageCategory" required>
                            <option value="">Select...</option>
                            <option value="10-20">10-20</option>
                            <option value="20-30">20-30</option>
                            <option value="30-40">30-40</option>
                            <option value="40-50">40-50</option>
                            <option value="50+">50+</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="gender">Gender</label>
                        <select id="gender" name="gender">
                            <option value="">Select...</option>
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                            <option value="non-binary">Non-binary</option>
                            <option value="prefer-not-to-say">Prefer not to say</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="dominantHand">Dominant Hand *</label>
                        <select id="dominantHand" name="dominantHand" required>
                            <option value="">Select...</option>
                            <option value="right">Right</option>
                            <option value="left">Left</option>
                        </select>
                    </div>
                </div>
                
                <!-- Row 2: Musical Background & Health -->
                <div class="form-row-3col">
                    <div class="form-group">
                        <label for="musicalBackground">Musical Background *</label>
                        <select id="musicalBackground" name="musicalBackground" required>
                            <option value="">Select...</option>
                            <option value="none">No formal training</option>
                            <option value="beginner">Beginner (1-2 years)</option>
                            <option value="intermediate">Intermediate (3-5 years)</option>
                            <option value="advanced">Advanced (6-10 years)</option>
                            <option value="professional">Professional (10+ years)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="currentMusicEngagement">Current Music Engagement *</label>
                        <select id="currentMusicEngagement" name="currentMusicEngagement" required>
                            <option value="">Select...</option>
                            <option value="rarely">Rarely listen to music</option>
                            <option value="occasionally">Occasionally (few times/week)</option>
                            <option value="daily">Daily listener</option>
                            <option value="constantly">Constantly (multiple hours/day)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="hearingImpairment">Hearing Impairment *</label>
                        <select id="hearingImpairment" name="hearingImpairment" required>
                            <option value="">Select...</option>
                            <option value="none">None</option>
                            <option value="mild">Mild</option>
                            <option value="moderate">Moderate</option>
                            <option value="severe">Severe</option>
                        </select>
                    </div>
                </div>

                <!-- Row 3: Sleep -->
                <div class="form-row-3col">
                    <div class="form-group">
                        <label for="sleepHours">Hours of Sleep Last Night</label>
                        <input type="number" id="sleepHours" name="sleepHours" min="0" max="24" step="0.5" placeholder="e.g., 7.5">
                    </div>
                    <div class="form-group"></div>
                    <div class="form-group"></div>
                </div>

                <!-- Row 4: Caffeine & Medications -->
                <div class="form-row-3col">
                    <div class="form-group">
                        <label for="caffeineSource">Caffeine Source Today</label>
                        <select id="caffeineSource" name="caffeineSource">
                            <option value="none">None</option>
                            <option value="coffee">Coffee</option>
                            <option value="tea">Tea</option>
                            <option value="energy-drink">Energy Drink</option>
                            <option value="soda">Caffeinated Soda</option>
                            <option value="multiple">Multiple Sources</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="caffeineAmount">Caffeine Amount</label>
                        <select id="caffeineAmount" name="caffeineAmount">
                            <option value="none">None</option>
                            <option value="low">Low (~50-100mg)</option>
                            <option value="moderate">Moderate (~100-200mg)</option>
                            <option value="high">High (~200-400mg)</option>
                            <option value="very-high">Very High (400mg+)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="medications">Current Medications</label>
                        <textarea id="medications" name="medications" rows="2" placeholder="List medications or write 'None'"></textarea>
                        <small style="display: block; margin-top: 4px; color: #FFD700; font-size: 0.85em; font-weight: 700; text-shadow: 2px 2px 4px rgba(0,0,0,0.9);">Include medications affecting attention or mood</small>
                    </div>
                </div>

                <!-- Additional Notes -->
                <div class="form-group full-width-section">
                    <label for="notes">Additional Notes</label>
                    <textarea id="notes" name="notes" rows="2" placeholder="Any additional information..."></textarea>
                </div>

                <div class="button-group">
                    <button type="button" class="btn btn-secondary" onclick="platform.showScreen('welcomeScreen')">
                        Back
                    </button>
                    <button type="submit" class="btn btn-primary">
                        Continue to Test Selection
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Test Selection Screen -->
    <div id="testSelectionScreen" class="screen hidden">
        <div class="container" style="max-width: 1000px;">
            <h2>Select Cognitive Tests</h2>
            <p style="text-align: center; margin-bottom: 30px; color: #ffffff; text-shadow: 1px 1px 2px rgba(0,0,0,0.4);">
                Choose which tests to include in this session
            </p>

            <div id="sessionInfo" class="info-box"></div>

            <div class="test-grid">
                <div class="test-card" data-test="simple-reaction">
                    <h3>‚ö° Simple Reaction Time</h3>
                    <p>Measure basic response speed to visual stimuli</p>
                    <p><small>Duration: 2 minutes</small></p>
                </div>

                <div class="test-card" data-test="choice-reaction">
                    <h3>üéØ Choice Reaction Time</h3>
                    <p>Respond to different colored targets with different buttons</p>
                    <p><small>Duration: 3 minutes</small></p>
                </div>

                <div class="test-card" data-test="go-nogo">
                    <h3>üö¶ Go/No-Go Task</h3>
                    <p>Test response inhibition and attention control</p>
                    <p><small>Duration: 3 minutes</small></p>
                </div>

                <div class="test-card" data-test="stroop">
                    <h3>üåà Stroop Test</h3>
                    <p>Measure selective attention and cognitive flexibility</p>
                    <p><small>Duration: 2 minutes</small></p>
                </div>

                <div class="test-card" data-test="digit-span">
                    <h3>üî¢ Digit Span</h3>
                    <p>Assess working memory capacity</p>
                    <p><small>Duration: 4 minutes</small></p>
                </div>

                <div class="test-card" data-test="n-back">
                    <h3>üß† N-Back Task</h3>
                    <p>Challenge working memory with continuous updating</p>
                    <p><small>Duration: 5 minutes</small></p>
                </div>
            </div>

            <div style="text-align: center; margin: 30px 0;">
                <button class="btn btn-secondary" id="standardBatteryBtn">
                    Select Standard Battery
                </button>
            </div>

            <div class="info-box">
                <h3 style="margin-bottom: 15px;">Music Conditions</h3>
                <div class="condition-selection">
                    <label><input type="checkbox" value="silence" checked> Silence (Control)</label>
                    <label><input type="checkbox" value="classical_low"> Classical - Low Tempo (60 BPM)</label>
                    <label><input type="checkbox" value="classical_high"> Classical - High Tempo (120 BPM)</label>
                    <label><input type="checkbox" value="ambient"> Ambient</label>
                    <label><input type="checkbox" value="electronic"> Electronic (140 BPM)</label>
                    <label><input type="checkbox" value="white_noise"> White Noise</label>
                    <label><input type="checkbox" value="binaural"> Binaural Beats (40Hz Focus)</label>
                </div>
            </div>

            <div class="button-group">
                <button class="btn btn-secondary" onclick="platform.showScreen('participantScreen')">
                    Back
                </button>
                <button class="btn btn-primary" id="startTestingBtn">
                    Start Testing Session
                </button>
            </div>
        </div>
    </div>

    <!-- Test Execution Screen -->
    <div id="testScreen" class="screen hidden">
        <div class="container" style="text-align: center;">
            <h2 id="testTitle">Test in Progress</h2>
            <p id="currentTestName" style="margin-bottom: 20px; opacity: 0.8;"></p>
            
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%;">0%</div>
                </div>
            </div>

            <!-- Visual Button Indicators - Hidden since tests render their own -->
            <div id="buttonIndicators" style="display: none;">
                <div class="kb-button-indicator" data-button="0" style="text-align: center;">
                    <div id="btn0" class="kb-led-circle" style="width: 60px; height: 60px; border-radius: 50%; background: #2d5a2d; border: 3px solid #4ade80; transition: all 0.1s;"></div>
                    <div style="margin-top: 5px; font-size: 0.9em;">A (Green)</div>
                </div>
                <div class="kb-button-indicator" data-button="1" style="text-align: center;">
                    <div id="btn1" class="kb-led-circle" style="width: 60px; height: 60px; border-radius: 50%; background: #4a4a4a; border: 3px solid #ffffff; transition: all 0.1s;"></div>
                    <div style="margin-top: 5px; font-size: 0.9em;">S (White)</div>
                </div>
                <div class="kb-button-indicator" data-button="2" style="text-align: center;">
                    <div id="btn2" class="kb-led-circle" style="width: 60px; height: 60px; border-radius: 50%; background: #5a2d2d; border: 3px solid #ff6b6b; transition: all 0.1s;"></div>
                    <div style="margin-top: 5px; font-size: 0.9em;">D (Red)</div>
                </div>
                <div class="kb-button-indicator" data-button="3" style="text-align: center;">
                    <div id="btn3" class="kb-led-circle" style="width: 60px; height: 60px; border-radius: 50%; background: #2d5a2d; border: 3px solid #22c55e; transition: all 0.1s;"></div>
                    <div style="margin-top: 5px; font-size: 0.9em;">F (Green)</div>
                </div>
            </div>
            
            <!-- Central Stimulus Display Area - PRIMARY VISUAL FEEDBACK -->
            <div id="centralStimulus" style="width: 250px; height: 250px; margin: 30px auto; border-radius: 50%; background: #1a1a2e; border: 5px solid #444; display: flex; align-items: center; justify-content: center; font-size: 4em; transition: all 0.15s; box-shadow: inset 0 0 30px rgba(0,0,0,0.5);">
                <span id="stimulusText" style="color: #666; font-weight: bold;">+</span>
            </div>
            <div id="stimulusMessage" style="text-align: center; font-size: 1.5em; margin: 15px 0; min-height: 40px; font-weight: bold; color: #fff;"></div>

            <div id="testContent" style="margin: 30px 0; min-height: 300px;">
                <!-- Test content will be rendered here by the test classes -->
            </div>

            <div class="info-box" id="testInstructions">
                <p><strong>Press A, S, D, or F</strong> to respond to stimuli</p>
                <p>Press <strong>SPACEBAR</strong> to start the test</p>
            </div>

            <div class="button-group">
                <button class="btn btn-secondary" id="pauseTestBtn">
                    Pause
                </button>
                <button class="btn btn-secondary" id="stopTestBtn">
                    Stop Test
                </button>
            </div>
        </div>
    </div>

    <!-- Results Screen -->
    <div id="resultsScreen" class="screen hidden">
        <div class="results-container">
            <h2>Session Results</h2>
            
            <div id="sessionSummary" class="info-box"></div>

            <div class="metric-grid" id="metricsDisplay">
                <div class="metric-card">
                    <div class="metric-label">Avg Reaction Time</div>
                    <div class="metric-value" id="avgRT">--</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Accuracy</div>
                    <div class="metric-value" id="accuracy">--</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Tests Completed</div>
                    <div class="metric-value" id="testsCompleted">--</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Total Trials</div>
                    <div class="metric-value" id="totalTrials">--</div>
                </div>
            </div>

            <div class="info-box">
                <h3>Performance Summary</h3>
                <div id="performanceSummary"></div>
            </div>

            <div class="button-group">
                <button class="btn btn-secondary" id="exportResultsBtn">
                    Export Data
                </button>
                <button class="btn btn-primary" id="newSessionFromResultsBtn">
                    Start New Session
                </button>
            </div>
        </div>
    </div>

    <!-- Load external scripts for Electron -->
    <script src="js/core/data-logger.js"></script>
    <script src="js/core/metrics-collector.js"></script>
    <script src="js/core/music-analyzer.js"></script>
    <script src="js/tests/test-base.js"></script>
    <script src="js/tests/simple-reaction.js"></script>
    <script src="js/tests/choice-reaction.js"></script>
    <script src="js/tests/go-nogo.js"></script>
    <script src="js/tests/stroop.js"></script>
    <script src="js/tests/digit-span.js"></script>
    <script src="js/tests/n-back.js"></script>
    <script src="js/platform.js"></script>
    
    <script>
        // Participant ID generation helper
        let participantCounter = parseInt(localStorage.getItem('lastParticipantNumber') || '0') + 1;
        
        function generateParticipantId() {
            const id = 'P' + String(participantCounter).padStart(6, '0');
            localStorage.setItem('lastParticipantNumber', participantCounter);
            participantCounter++;
            return id;
        }
        
        // Override showScreen to handle participant ID generation
        const originalShowScreen = MusicCognitionPlatform.prototype.showScreen;
        MusicCognitionPlatform.prototype.showScreen = function(screenId, data) {
            originalShowScreen.call(this, screenId, data);
            
            if (screenId === 'participantScreen') {
                const participantId = generateParticipantId();
                const displayElement = document.getElementById('displayParticipantId');
                if (displayElement) {
                    displayElement.textContent = participantId;
                }
                this.currentParticipantId = participantId;
            }
        };
        
        // Override handleParticipantSubmit to use form data properly
        MusicCognitionPlatform.prototype.handleParticipantSubmit = async function(event) {
            if (event) event.preventDefault();
            
            console.log('üìù handleParticipantSubmit called');
            
            // Validate required fields
            const ageCategory = document.getElementById('ageCategory').value;
            const dominantHand = document.getElementById('dominantHand').value;
            const musicalBackground = document.getElementById('musicalBackground').value;
            const currentMusicEngagement = document.getElementById('currentMusicEngagement').value;
            const hearingImpairment = document.getElementById('hearingImpairment').value;
            
            if (!ageCategory || !dominantHand || !musicalBackground || !currentMusicEngagement || !hearingImpairment) {
                alert('Please fill in all required fields marked with *');
                return;
            }
            
            const participantId = this.currentParticipantId || generateParticipantId();
            
            // Create session object
            this.currentSession = {
                id: 'SESSION_' + Date.now(),
                participant: {
                    id: participantId,
                    ageCategory: ageCategory,
                    gender: document.getElementById('gender').value || 'not-specified',
                    dominantHand: dominantHand,
                    musicalBackground: musicalBackground,
                    currentMusicEngagement: currentMusicEngagement,
                    hearingImpairment: hearingImpairment,
                    medications: document.getElementById('medications').value || 'None',
                    caffeineSource: document.getElementById('caffeineSource').value || 'none',
                    caffeineAmount: document.getElementById('caffeineAmount').value || 'none',
                    sleepHours: parseFloat(document.getElementById('sleepHours').value) || null,
                    notes: document.getElementById('notes').value || ''
                },
                startTime: new Date().toISOString(),
                tests: [],
                results: {}
            };
            
            console.log('‚úÖ Session created:', this.currentSession.id);
            console.log('üë§ Participant:', this.currentSession.participant.id);
            
            // Update session info display
            this.populateSessionInfo(this.currentSession);
            
            // Show test selection screen
            this.showScreen('testSelectionScreen');
        };
        
        // Add populateSessionInfo method if not present
        MusicCognitionPlatform.prototype.populateSessionInfo = function(session) {
            const sessionInfo = document.getElementById('sessionInfo');
            if (sessionInfo && session) {
                const p = session.participant;
                const musicLevel = p.musicalBackground === 'none' ? 'No training' : 
                                 p.musicalBackground === 'professional' ? 'Professional' :
                                 p.musicalBackground.charAt(0).toUpperCase() + p.musicalBackground.slice(1).replace('-', ' ');
                sessionInfo.innerHTML = `
                    <strong>Participant ID:</strong> ${p.id} | 
                    <strong>Age:</strong> ${p.ageCategory} | 
                    <strong>Hand:</strong> ${p.dominantHand} | 
                    <strong>Musical Background:</strong> ${musicLevel}
                `;
            }
        };
        
        // DIRECT KEYBOARD HANDLER - ensures keyboard works even if platform fails
        const keyMap = { 'KeyA': 0, 'KeyS': 1, 'KeyD': 2, 'KeyF': 3, 'Space': 0 };
        const buttonColors = ['#4ade80', '#ffffff', '#ff6b6b', '#22c55e'];
        const buttonStates = [false, false, false, false];
        
        document.addEventListener('keydown', (event) => {
            const buttonIndex = keyMap[event.code];
            if (buttonIndex !== undefined && !buttonStates[buttonIndex]) {
                // Prevent spacebar from scrolling
                if (event.code === 'Space') {
                    event.preventDefault();
                }
                
                buttonStates[buttonIndex] = true;
                console.log(`‚å®Ô∏è Key pressed: ${event.code} -> Button ${buttonIndex}`);
                
                // Visual feedback - light up the button
                const btnElement = document.getElementById(`btn${buttonIndex}`);
                if (btnElement) {
                    btnElement.style.background = buttonColors[buttonIndex];
                    btnElement.style.boxShadow = `0 0 20px ${buttonColors[buttonIndex]}`;
                }
                
                // Forward to platform if available
                if (window.platform && window.platform.testInstance) {
                    const timestamp = performance.now();
                    const buttonData = {
                        button: buttonIndex + 1,  // 1-indexed like hardware
                        timestamp: timestamp
                    };
                    
                    // Check if test is waiting for instruction confirmation
                    if (window.platform.testInstance.instructionResolver) {
                        console.log('Resolving instruction screen...');
                        window.platform.testInstance.instructionResolver();
                        window.platform.testInstance.instructionResolver = null;
                        if (window.platform.testInstance.start) {
                            window.platform.testInstance.start();
                        }
                    } else if (window.platform.testInstance.isRunning) {
                        console.log('Recording response: button', buttonIndex, 'at', timestamp);
                        
                        // Show response in stimulus message
                        const stimulusMessage = document.getElementById('stimulusMessage');
                        if (stimulusMessage) {
                            stimulusMessage.textContent = `Response: Button ${buttonIndex + 1}`;
                        }
                        
                        // Call test's handleButtonPress with CORRECT ARGUMENTS
                        // Tests expect (buttonIndex, timestamp, buttonData)
                        if (window.platform.testInstance.handleButtonPress) {
                            window.platform.testInstance.handleButtonPress(buttonIndex, timestamp, buttonData);
                        }
                    } else {
                        // Try to start the test
                        console.log('Test not running, attempting to start...');
                        if (window.platform.testInstance.start) {
                            window.platform.testInstance.start();
                        }
                    }
                } else {
                    console.log('No test instance available');
                }
            }
        });
        
        document.addEventListener('keyup', (event) => {
            const buttonIndex = keyMap[event.code];
            if (buttonIndex !== undefined) {
                buttonStates[buttonIndex] = false;
                
                // Visual feedback - dim the button
                const btnElement = document.getElementById(`btn${buttonIndex}`);
                if (btnElement) {
                    const dimColors = ['#2d5a2d', '#4a4a4a', '#5a2d2d', '#2d5a2d'];
                    btnElement.style.background = dimColors[buttonIndex];
                    btnElement.style.boxShadow = 'none';
                }
            }
        });
        
        console.log('‚úÖ Direct keyboard handler installed (A, S, D, F keys)');

        // Wait for platform to be ready, then ensure event listeners are set up
        document.addEventListener('DOMContentLoaded', () => {
            // Give platform.js time to initialize
            setTimeout(() => {
                if (window.platform) {
                    console.log('‚úÖ Platform connected to UI');
                    
                    // PATCH: Add missing test configurations
                    if (!platform.testConfigurations['go-nogo']) {
                        platform.testConfigurations['go-nogo'] = {
                            name: 'Go/No-Go Task',
                            class: 'GoNoGoTest',
                            duration: 180000,
                            buttonConfig: 'single',
                            description: 'Respond to GO stimuli, inhibit response to NO-GO stimuli',
                            metrics: ['goHits', 'falseAlarms', 'inhibitionAccuracy']
                        };
                    }
                    
                    if (!platform.testConfigurations['digit-span']) {
                        platform.testConfigurations['digit-span'] = {
                            name: 'Digit Span',
                            class: 'DigitSpanTest',
                            duration: 240000,
                            buttonConfig: 'all_four',
                            description: 'Remember and reproduce sequences of digits',
                            metrics: ['forwardSpan', 'backwardSpan', 'totalSpan']
                        };
                    }
                    
                    // Patch getTestClass to include missing tests
                    const originalGetTestClass = platform.getTestClass.bind(platform);
                    platform.getTestClass = function(testType) {
                        if (testType === 'go-nogo') {
                            return typeof GoNoGoTest !== 'undefined' ? GoNoGoTest : null;
                        }
                        if (testType === 'digit-span') {
                            return typeof DigitSpanTest !== 'undefined' ? DigitSpanTest : null;
                        }
                        return originalGetTestClass(testType);
                    };
                    console.log('‚úÖ Patched missing test configurations (go-nogo, digit-span)');
                    
                    // PATCH: Make LED controls update visual indicators AND central stimulus
                    const buttonColors = ['#4ade80', '#ffffff', '#ff6b6b', '#22c55e'];
                    const dimColors = ['#2d5a2d', '#4a4a4a', '#5a2d2d', '#2d5a2d'];
                    const buttonNames = ['GREEN (A)', 'WHITE (S)', 'RED (D)', 'GREEN (F)'];
                    
                    const originalSetLED = platform.setLED.bind(platform);
                    platform.setLED = async function(buttonNumber, state) {
                        const idx = buttonNumber - 1;
                        
                        // Update button indicator
                        const btnElement = document.getElementById(`btn${idx}`);
                        if (btnElement) {
                            if (state) {
                                btnElement.style.background = buttonColors[idx];
                                btnElement.style.boxShadow = `0 0 20px ${buttonColors[idx]}`;
                            } else {
                                btnElement.style.background = dimColors[idx];
                                btnElement.style.boxShadow = 'none';
                            }
                        }
                        
                        // Update central stimulus display
                        const centralStimulus = document.getElementById('centralStimulus');
                        const stimulusText = document.getElementById('stimulusText');
                        const stimulusMessage = document.getElementById('stimulusMessage');
                        
                        if (centralStimulus && state) {
                            centralStimulus.style.background = buttonColors[idx];
                            centralStimulus.style.boxShadow = `0 0 50px ${buttonColors[idx]}`;
                            if (stimulusText) stimulusText.textContent = '!';
                            if (stimulusText) stimulusText.style.color = idx === 1 ? '#000' : '#fff';
                            if (stimulusMessage) stimulusMessage.textContent = `Press ${buttonNames[idx]} button!`;
                            console.log(`üîÜ Stimulus ON: Button ${buttonNumber} (${buttonNames[idx]})`);
                        } else if (centralStimulus && !state) {
                            // Only dim if no other LED is on
                            let anyOn = false;
                            for (let i = 0; i < 4; i++) {
                                const btn = document.getElementById(`btn${i}`);
                                if (btn && btn.style.background === buttonColors[i]) {
                                    anyOn = true;
                                    break;
                                }
                            }
                            if (!anyOn) {
                                centralStimulus.style.background = '#1a1a2e';
                                centralStimulus.style.boxShadow = 'none';
                                if (stimulusText) stimulusText.textContent = '+';
                                if (stimulusText) stimulusText.style.color = '#666';
                                if (stimulusMessage) stimulusMessage.textContent = 'Wait for stimulus...';
                            }
                        }
                        
                        // Still try original (for hardware if connected)
                        return originalSetLED(buttonNumber, state);
                    };
                    
                    const originalSetAllLEDs = platform.setAllLEDs.bind(platform);
                    platform.setAllLEDs = async function(state) {
                        const centralStimulus = document.getElementById('centralStimulus');
                        const stimulusText = document.getElementById('stimulusText');
                        const stimulusMessage = document.getElementById('stimulusMessage');
                        
                        for (let i = 0; i < 4; i++) {
                            const btnElement = document.getElementById(`btn${i}`);
                            if (btnElement) {
                                if (state) {
                                    btnElement.style.background = buttonColors[i];
                                    btnElement.style.boxShadow = `0 0 20px ${buttonColors[i]}`;
                                } else {
                                    btnElement.style.background = dimColors[i];
                                    btnElement.style.boxShadow = 'none';
                                }
                            }
                        }
                        
                        if (centralStimulus) {
                            if (state) {
                                centralStimulus.style.background = '#ffffff';
                                centralStimulus.style.boxShadow = '0 0 50px #ffffff';
                                if (stimulusText) { stimulusText.textContent = '!'; stimulusText.style.color = '#000'; }
                                if (stimulusMessage) stimulusMessage.textContent = 'All buttons active!';
                            } else {
                                centralStimulus.style.background = '#1a1a2e';
                                centralStimulus.style.boxShadow = 'none';
                                if (stimulusText) { stimulusText.textContent = '+'; stimulusText.style.color = '#666'; }
                                if (stimulusMessage) stimulusMessage.textContent = 'Wait for stimulus...';
                            }
                        }
                        
                        return originalSetAllLEDs(state);
                    };
                    console.log('‚úÖ Patched LED controls for visual feedback');
                    
                    // Add delay helper if missing
                    if (!platform.delay) {
                        platform.delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));
                    }
                    
                    // Add showVisualStimulus helper for tests to show custom content
                    platform.showVisualStimulus = function(options = {}) {
                        const centralStimulus = document.getElementById('centralStimulus');
                        const stimulusText = document.getElementById('stimulusText');
                        const stimulusMessage = document.getElementById('stimulusMessage');
                        
                        if (centralStimulus) {
                            centralStimulus.style.background = options.color || '#1a1a2e';
                            centralStimulus.style.boxShadow = options.color ? `0 0 50px ${options.color}` : 'none';
                        }
                        if (stimulusText) {
                            stimulusText.textContent = options.text || '+';
                            stimulusText.style.color = options.textColor || '#666';
                            stimulusText.style.fontSize = options.fontSize || '3em';
                        }
                        if (stimulusMessage) {
                            stimulusMessage.textContent = options.message || '';
                        }
                        
                        console.log(`üéØ Visual stimulus: ${options.text || 'reset'}`);
                    };
                    
                    // Add clearStimulus helper
                    platform.clearStimulus = function() {
                        platform.showVisualStimulus({ text: '+', color: '#1a1a2e', textColor: '#666', message: 'Wait for stimulus...' });
                        // Also turn off all button indicators
                        for (let i = 0; i < 4; i++) {
                            const btnElement = document.getElementById(`btn${i}`);
                            if (btnElement) {
                                btnElement.style.background = dimColors[i];
                                btnElement.style.boxShadow = 'none';
                            }
                        }
                    };
                    
                    console.log('‚úÖ Added visual stimulus helpers');
                    
                    // PATCH: Override querySelectorAll for button-indicator to only find ones in testContent
                    // This prevents conflicts with other elements on the page
                    const originalQuerySelectorAll = document.querySelectorAll.bind(document);
                    document.querySelectorAll = function(selector) {
                        if (selector === '.button-indicator') {
                            // Only return button-indicators inside testContent
                            const testContent = document.getElementById('testContent');
                            if (testContent) {
                                return testContent.querySelectorAll('.button-indicator');
                            }
                        }
                        return originalQuerySelectorAll(selector);
                    };
                    console.log('‚úÖ Patched querySelectorAll for button-indicator scope');
                    
                    // CRITICAL: Disable platform.js event handlers to prevent duplicates
                    // We'll handle all events from index.html
                    platform._eventHandlersDisabled = true;
                    
                    // Override setupEventListeners to prevent duplicate handlers
                    platform.setupEventListeners = function() {
                        console.log('‚ö†Ô∏è setupEventListeners disabled - using index.html handlers');
                    };
                    
                    // PATCH: Better startNextTest with logging
                    const originalStartNextTest = platform.startNextTest.bind(platform);
                    platform.startNextTest = async function() {
                        console.log('üîÑ startNextTest called, testIndex:', this.testIndex, 'queue length:', this.testQueue.length);
                        
                        if (this.testIndex >= this.testQueue.length) {
                            console.log('üèÅ All tests completed');
                            await this.completeTestBattery();
                            return;
                        }
                        
                        const testConfig = this.testQueue[this.testIndex];
                        console.log('üìù Current test config:', testConfig);
                        
                        if (!testConfig || !testConfig.config) {
                            console.error('‚ùå Invalid test config at index', this.testIndex);
                            this.testIndex++;
                            return this.startNextTest();
                        }
                        
                        // Update progress
                        this.updateTestProgress();
                        
                        // Show test info
                        const testNameEl = document.getElementById('currentTestName');
                        if (testNameEl) {
                            testNameEl.textContent = `${testConfig.config.name} - ${testConfig.musicCondition}`;
                        }
                        
                        try {
                            // Setup music condition
                            console.log('üéµ Setting up music condition:', testConfig.musicCondition);
                            await this.setupMusicCondition(testConfig.musicCondition);
                            
                            // Initialize test instance
                            console.log('üß™ Initializing test:', testConfig.testType);
                            await this.initializeTest(testConfig);
                            
                            console.log('‚úÖ Test initialized, testInstance:', this.testInstance ? 'SET' : 'NULL');
                            
                        } catch (error) {
                            console.error('‚ùå Test start error:', error);
                            this.testIndex++;
                            return this.startNextTest();
                        }
                    };
                    
                    // PATCH: Better initializeTest with logging AND complete() patching
                    platform.initializeTest = async function(testConfig) {
                        console.log('üîß initializeTest called for:', testConfig.testType);
                        
                        // Get test class
                        const TestClass = this.getTestClass(testConfig.testType);
                        console.log('üìö TestClass found:', TestClass ? 'YES' : 'NO');
                        
                        if (!TestClass) {
                            console.error('‚ùå Test class not found:', testConfig.testType);
                            this.testIndex++;
                            return this.startNextTest();
                        }
                        
                        try {
                            // Create test instance
                            console.log('üÜï Creating test instance...');
                            this.testInstance = new TestClass(testConfig.config, this);
                            console.log('‚úÖ Test instance created:', this.testInstance);
                            
                            // PATCH: Wrap the complete() method to notify platform
                            const originalComplete = this.testInstance.complete.bind(this.testInstance);
                            const platformRef = this;
                            
                            this.testInstance.complete = async function() {
                                console.log('üèÅ Test complete() called');
                                this.isRunning = false;
                                
                                // Turn off LEDs
                                await platformRef.setAllLEDs(false);
                                
                                // Calculate metrics
                                const metrics = this.calculateMetrics ? this.calculateMetrics() : {};
                                console.log('üìä Calculated metrics:', metrics);
                                
                                // Notify platform to move to next test
                                setTimeout(() => {
                                    platformRef.completeCurrentTest();
                                }, 500);
                                
                                return {
                                    testName: this.config ? this.config.name : 'Unknown',
                                    metrics: metrics
                                };
                            };
                            console.log('‚úÖ Patched test instance complete() method');
                            
                            // Initialize and run test
                            console.log('üéÆ Calling test.initialize()...');
                            await this.testInstance.initialize();
                            console.log('‚úÖ Test initialized successfully');
                            
                        } catch (error) {
                            console.error('‚ùå Test initialization error:', error);
                            this.testInstance = null;
                            this.testIndex++;
                            return this.startNextTest();
                        }
                    };
                    
                    console.log('‚úÖ Patched startNextTest and initializeTest');
                    
                    // PATCH: Override test completion to properly transition
                    const originalCompleteCurrentTest = platform.completeCurrentTest.bind(platform);
                    platform.completeCurrentTest = async function() {
                        console.log('üèÅ completeCurrentTest called');
                        
                        if (!this.testInstance) {
                            console.log('‚ö†Ô∏è No test instance to complete');
                            return;
                        }
                        
                        try {
                            // Get test results
                            const testResults = this.testInstance.calculateMetrics ? 
                                this.testInstance.calculateMetrics() : {};
                            
                            console.log('üìä Test results:', testResults);
                            
                            // Store results
                            if (this.currentSession) {
                                this.currentSession.results = this.currentSession.results || {};
                                const testConfig = this.testQueue[this.testIndex];
                                const key = `${testConfig.testType}_${testConfig.musicCondition}`;
                                this.currentSession.results[key] = {
                                    ...testResults,
                                    testType: testConfig.testType,
                                    musicCondition: testConfig.musicCondition,
                                    completedAt: new Date().toISOString()
                                };
                            }
                            
                            // Clean up
                            if (this.testInstance.destroy) {
                                this.testInstance.destroy();
                            }
                            this.testInstance = null;
                            
                            // Stop music
                            this.stopMusic();
                            
                            // Move to next test
                            this.testIndex++;
                            
                            if (this.testIndex >= this.testQueue.length) {
                                // All tests completed - show results
                                console.log('üéâ All tests completed! Showing results...');
                                await this.showResultsScreen();
                            } else {
                                // Show brief break then next test
                                console.log('‚è≠Ô∏è Moving to next test...');
                                await this.showInterTestBreak();
                                await this.startNextTest();
                            }
                            
                        } catch (error) {
                            console.error('‚ùå Error in completeCurrentTest:', error);
                            this.showScreen('testSelectionScreen');
                        }
                    };
                    
                    // PATCH: Add showResultsScreen if not present
                    platform.showResultsScreen = async function() {
                        console.log('üìà Showing results screen');
                        
                        // Hide unnecessary elements on test screen
                        const demoBtn = document.getElementById('demoTestBtn');
                        const pauseBtn = document.getElementById('pauseTestBtn');
                        const stopBtn = document.getElementById('stopTestBtn');
                        const testInstructions = document.getElementById('testInstructions');
                        const centralStimulus = document.getElementById('centralStimulus');
                        const stimulusMessage = document.getElementById('stimulusMessage');
                        const buttonIndicators = document.getElementById('buttonIndicators');
                        
                        if (demoBtn) demoBtn.style.display = 'none';
                        if (pauseBtn) pauseBtn.parentElement.style.display = 'none'; // Hide button group
                        if (testInstructions) testInstructions.style.display = 'none';
                        if (centralStimulus) centralStimulus.style.display = 'none';
                        if (stimulusMessage) stimulusMessage.style.display = 'none';
                        if (buttonIndicators) buttonIndicators.style.display = 'none';
                        
                        const testContent = document.getElementById('testContent');
                        if (testContent) {
                            let resultsHTML = `
                                <div style="text-align: center; padding: 20px;">
                                    <h2 style="color: #4ade80; margin-bottom: 20px;">üéâ Session Complete!</h2>
                                    <p>All tests have been completed.</p>
                                    <div style="margin: 30px 0; text-align: left; max-width: 600px; margin-left: auto; margin-right: auto;">
                                        <h3>Results Summary:</h3>
                            `;
                            
                            if (this.currentSession && this.currentSession.results) {
                                for (const [key, result] of Object.entries(this.currentSession.results)) {
                                    resultsHTML += `
                                        <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; margin: 10px 0;">
                                            <strong>${result.testType}</strong> (${result.musicCondition})<br>
                                            ${result.accuracy !== undefined ? `Accuracy: ${result.accuracy}%<br>` : ''}
                                            ${result.meanRT !== undefined ? `Mean RT: ${Math.round(result.meanRT)}ms<br>` : ''}
                                            ${result.correctResponses !== undefined ? `Correct: ${result.correctResponses}<br>` : ''}
                                            ${result.incorrectResponses !== undefined ? `Incorrect: ${result.incorrectResponses}` : ''}
                                        </div>
                                    `;
                                }
                            } else {
                                resultsHTML += '<p>No results data available.</p>';
                            }
                            
                            resultsHTML += `
                                    </div>
                                    <div style="margin-top: 30px;">
                                        <button class="btn btn-primary" onclick="platform.returnToTestSelection()" style="margin: 5px;">
                                            Run More Tests
                                        </button>
                                        <button class="btn btn-secondary" onclick="platform.showScreen('welcomeScreen')" style="margin: 5px;">
                                            New Session
                                        </button>
                                    </div>
                                </div>
                            `;
                            
                            testContent.innerHTML = resultsHTML;
                        }
                        
                        // Update title
                        const testTitle = document.getElementById('testTitle');
                        if (testTitle) {
                            testTitle.textContent = 'Session Complete';
                        }
                        
                        // Hide progress bar
                        const progressContainer = document.querySelector('.progress-container');
                        if (progressContainer) {
                            progressContainer.style.display = 'none';
                        }
                    };
                    
                    // PATCH: Add helper to return to test selection and restore UI
                    platform.returnToTestSelection = function() {
                        // Restore hidden elements for next test session
                        const demoBtn = document.getElementById('demoTestBtn');
                        const pauseBtn = document.getElementById('pauseTestBtn');
                        const stopBtn = document.getElementById('stopTestBtn');
                        const testInstructions = document.getElementById('testInstructions');
                        const centralStimulus = document.getElementById('centralStimulus');
                        const stimulusMessage = document.getElementById('stimulusMessage');
                        const progressContainer = document.querySelector('.progress-container');
                        
                        if (demoBtn) demoBtn.style.display = '';
                        if (pauseBtn && pauseBtn.parentElement) pauseBtn.parentElement.style.display = '';
                        if (testInstructions) testInstructions.style.display = '';
                        if (centralStimulus) centralStimulus.style.display = '';
                        if (stimulusMessage) stimulusMessage.style.display = '';
                        if (progressContainer) progressContainer.style.display = '';
                        
                        this.showScreen('testSelectionScreen');
                    };
                    
                    // PATCH: Simplified inter-test break
                    platform.showInterTestBreak = async function() {
                        console.log('‚è∏Ô∏è Showing inter-test break');
                        
                        const testContent = document.getElementById('testContent');
                        if (!testContent) return;
                        
                        testContent.innerHTML = `
                            <div style="text-align: center; padding: 40px;">
                                <h2 style="color: #4ade80;">‚úì Test Complete!</h2>
                                <p>Take a short break before the next test</p>
                                <div style="font-size: 3em; margin: 30px 0;" id="breakTimer">5</div>
                                <p>Next test starts in...</p>
                                <button class="btn btn-primary" id="skipBreakBtn">Skip Break</button>
                            </div>
                        `;
                        
                        return new Promise((resolve) => {
                            let remaining = 5;
                            const breakTimer = document.getElementById('breakTimer');
                            const skipBtn = document.getElementById('skipBreakBtn');
                            
                            const countdown = setInterval(() => {
                                remaining--;
                                if (breakTimer) {
                                    breakTimer.textContent = remaining;
                                }
                                
                                if (remaining <= 0) {
                                    clearInterval(countdown);
                                    resolve();
                                }
                            }, 1000);
                            
                            if (skipBtn) {
                                skipBtn.onclick = () => {
                                    clearInterval(countdown);
                                    resolve();
                                };
                            }
                        });
                    };
                    
                    console.log('‚úÖ Patched test completion handlers');
                    
                    // REMOVE any existing click handlers on test cards first
                    document.querySelectorAll('.test-card').forEach(card => {
                        const newCard = card.cloneNode(true);
                        card.parentNode.replaceChild(newCard, card);
                    });
                    
                    // Add fresh click handlers for test cards
                    document.querySelectorAll('.test-card').forEach(card => {
                        card.addEventListener('click', (e) => {
                            e.stopPropagation();
                            card.classList.toggle('selected');
                            console.log(`Test ${card.dataset.test} ${card.classList.contains('selected') ? 'selected' : 'deselected'}`);
                        });
                    });
                    
                    // Standard battery button
                    const standardBtn = document.getElementById('standardBatteryBtn');
                    if (standardBtn) {
                        // Remove old handlers
                        const newStandardBtn = standardBtn.cloneNode(true);
                        standardBtn.parentNode.replaceChild(newStandardBtn, standardBtn);
                        newStandardBtn.addEventListener('click', () => {
                            document.querySelectorAll('.test-card').forEach(card => {
                                card.classList.add('selected');
                            });
                            console.log('All tests selected');
                        });
                    }
                    
                    // Start testing button - ONLY use this handler, disable platform.js one
                    const startBtn = document.getElementById('startTestingBtn');
                    if (startBtn) {
                        const newStartBtn = startBtn.cloneNode(true);
                        startBtn.parentNode.replaceChild(newStartBtn, startBtn);
                        newStartBtn.addEventListener('click', async (e) => {
                            e.stopPropagation();
                            e.stopImmediatePropagation();
                            
                            // Prevent double execution
                            if (window._testBatteryStarting) {
                                console.log('Test battery already starting, ignoring duplicate');
                                return;
                            }
                            window._testBatteryStarting = true;
                            setTimeout(() => { window._testBatteryStarting = false; }, 2000);
                            
                        // Debug: Check what's selected
                            const selectedTests = Array.from(document.querySelectorAll('.test-card.selected'))
                                .map(card => card.dataset.test);
                            const selectedConditions = Array.from(document.querySelectorAll('.condition-selection input:checked'))
                                .map(cb => cb.value);
                            
                            console.log('üöÄ START BUTTON CLICKED');
                            console.log('üìã Selected tests:', selectedTests);
                            console.log('üéµ Selected conditions:', selectedConditions);
                            console.log('üîë Current session:', platform.currentSession ? platform.currentSession.id : 'NONE');
                            
                            // Check for session
                            if (!platform.currentSession) {
                                alert('No active session. Please fill out participant information first.');
                                window._testBatteryStarting = false;
                                return;
                            }
                            
                            if (selectedTests.length === 0) {
                                alert('Please select at least one test');
                                window._testBatteryStarting = false;
                                return;
                            }
                            if (selectedConditions.length === 0) {
                                alert('Please select at least one music condition');
                                window._testBatteryStarting = false;
                                return;
                            }
                            
                            // Build test queue manually
                            platform.testQueue = [];
                            selectedTests.forEach(testType => {
                                selectedConditions.forEach(condition => {
                                    const config = platform.testConfigurations[testType];
                                    if (config) {
                                        platform.testQueue.push({
                                            testType: testType,
                                            musicCondition: condition,
                                            config: config
                                        });
                                    } else {
                                        console.warn(`‚ö†Ô∏è No config found for test: ${testType}`);
                                    }
                                });
                            });
                            
                            console.log('üì¶ Test queue built:', platform.testQueue.length, 'tests');
                            console.log('üì¶ Queue contents:', platform.testQueue);
                            
                            if (platform.testQueue.length === 0) {
                                alert('No valid tests in queue');
                                window._testBatteryStarting = false;
                                return;
                            }
                            
                            platform.testIndex = 0;
                            platform.showScreen('testScreen');
                            
                            // Start first test with error handling
                            try {
                                console.log('üé¨ Starting first test...');
                                await platform.startNextTest();
                                console.log('‚úÖ startNextTest completed');
                            } catch (err) {
                                console.error('‚ùå startNextTest failed:', err);
                            }
                        });
                    }
                    
                    // Pause button - REMOVE duplicate handlers
                    const pauseBtn = document.getElementById('pauseTestBtn');
                    if (pauseBtn) {
                        const newPauseBtn = pauseBtn.cloneNode(true);
                        pauseBtn.parentNode.replaceChild(newPauseBtn, pauseBtn);
                        newPauseBtn.addEventListener('click', () => {
                            platform.pauseCurrentTest();
                        });
                    }
                    
                    // Stop button - REMOVE duplicate handlers
                    const stopBtn = document.getElementById('stopTestBtn');
                    if (stopBtn) {
                        const newStopBtn = stopBtn.cloneNode(true);
                        stopBtn.parentNode.replaceChild(newStopBtn, stopBtn);
                        newStopBtn.addEventListener('click', () => {
                            platform.stopCurrentTest();
                        });
                    }
                    
                    // Export button
                    const exportBtn = document.getElementById('exportResultsBtn');
                    if (exportBtn) {
                        exportBtn.addEventListener('click', () => {
                            platform.exportResults();
                        });
                    }
                    
                    // New session button
                    const newSessionBtn = document.getElementById('newSessionFromResultsBtn');
                    if (newSessionBtn) {
                        newSessionBtn.addEventListener('click', () => {
                            platform.showScreen('participantScreen');
                        });
                    }
                    
                    // Participant form submission
                    const participantForm = document.getElementById('participantForm');
                    if (participantForm) {
                        participantForm.addEventListener('submit', (e) => {
                            e.preventDefault();
                            platform.handleParticipantSubmit(e);
                        });
                    }
                } else {
                    console.error('‚ùå Platform not initialized!');
                }
            }, 100);
        });
    </script>
</body>
</html>