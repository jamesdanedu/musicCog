<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music & Cognition Research Platform</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #c94b4b 0%, #4b134f 100%);
            color: #ffffff;
            overflow-x: hidden;
        }

        .container {
            width: 100%;
            margin: 0;
            padding: 10px 20px;
        }

        .screen {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            padding: 20px;
        }

        .hidden {
            display: none !important;
        }

        /* Header Styles */
        header {
            text-align: center;
            margin-bottom: 40px;
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            color: #ffffff;
        }

        h2 {
            font-size: 1.8em;
            margin-bottom: 20px;
            color: #ffffff;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.4);
        }

        .subtitle {
            font-size: 1.2em;
            color: #ffffff;
            margin-bottom: 30px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        /* Welcome Screen */
        .welcome-content {
            text-align: center;
            max-width: 95%;
            width: 100%;
        }

        .welcome-content p {
            font-size: 1.1em;
            line-height: 1.6;
            margin-bottom: 20px;
            color: #ffffff;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        .system-check {
            margin: 40px 0;
            padding: 30px;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .status-card {
            background: rgba(255,255,255,0.15);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            transition: transform 0.3s;
        }

        .status-card:hover {
            transform: translateY(-5px);
        }

        .status-icon {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .status-text h4 {
            margin-bottom: 5px;
            color: #fff;
        }

        .status-text span {
            color: #4ade80;
            font-weight: bold;
        }

        /* Button Styles */
        .btn {
            padding: 15px 40px;
            font-size: 1.1em;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #ff6b6b 0%, #c94b4b 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.6);
        }

        .btn-secondary {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
        }

        .btn-secondary:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Form Styles */
        .form-container {
            background: rgba(255,255,255,0.15);
            padding: 30px 40px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            width: 95%;
            max-width: none;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            margin-top: 20px;
        }

        .form-container h2 {
            margin-bottom: 10px;
        }

        .participant-form {
            margin-top: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 25px;
            margin-bottom: 20px;
        }

        .form-row-2col {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 20px;
        }

        .form-row-3col {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 25px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 0;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #ffffff;
            font-size: 0.95em;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            color: #ffffff;
            font-size: 1em;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #ff6b6b;
        }

        .form-group select option {
            background: #4b134f;
            color: #ffffff;
        }

        /* Test Cards */
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .test-card {
            background: rgba(255,255,255,0.1);
            padding: 25px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .test-card:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-3px);
        }

        .test-card.selected {
            border-color: #4ade80;
            background: rgba(74, 222, 128, 0.2);
        }

        .test-card h3 {
            margin-bottom: 10px;
            color: #ffffff;
        }

        .test-card p {
            color: rgba(255,255,255,0.8);
            font-size: 0.95em;
        }

        /* Results */
        .results-container {
            background: rgba(255,255,255,0.15);
            padding: 40px;
            border-radius: 15px;
            width: 95%;
            max-width: 1200px;
        }

        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .metric-card {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .metric-label {
            font-size: 0.9em;
            color: rgba(255,255,255,0.7);
            margin-bottom: 10px;
        }

        .metric-value {
            font-size: 2em;
            font-weight: bold;
        }

        /* Info Display */
        .info-box {
            background: rgba(255,255,255,0.15);
            padding: 15px 20px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 4px solid #ff6b6b;
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
        }

        /* Progress Bar */
        .progress-container {
            width: 100%;
            max-width: 600px;
            margin: 20px auto;
        }

        .progress-bar {
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            height: 30px;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(90deg, #4ade80, #22c55e);
            height: 100%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            h1 { font-size: 2em; }
            .form-row, .form-row-3col { grid-template-columns: 1fr; }
            .test-grid { grid-template-columns: 1fr; }
            .form-container, .results-container { padding: 25px; }
        }

        .full-width-section {
            grid-column: 1 / -1;
        }

        /* Loading */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #ff6b6b;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Welcome Screen - Two Pathway Design -->
    <div id="welcomeScreen" class="screen">
        <div class="container">
            <header>
                <h1>üéµ Music & Cognition Research Platform</h1>
                <p class="subtitle">Investigating the Effects of Music on Cognitive Performance</p>
            </header>
            
            <div class="welcome-content">
                <!-- Two Pathway Cards -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; max-width: 800px; margin: 40px auto;">
                    
                    <!-- Run Studies Card -->
                    <div class="pathway-card" onclick="app.showScreen('participantScreen')" style="background: rgba(255,255,255,0.1); padding: 40px 30px; border-radius: 15px; cursor: pointer; transition: all 0.3s; border: 2px solid transparent; text-align: center;">
                        <div style="font-size: 4em; margin-bottom: 20px;">üß™</div>
                        <h2 style="margin-bottom: 15px; font-size: 1.5em;">Run Studies</h2>
                        <p style="color: rgba(255,255,255,0.8); margin-bottom: 20px;">
                            Collect new participant data through cognitive testing sessions
                        </p>
                        <div style="background: rgba(255,107,107,0.3); padding: 8px 16px; border-radius: 20px; display: inline-block; font-size: 0.9em;">
                            ~17 min per session
                        </div>
                    </div>
                    
                    <!-- View Analytics Card -->
                    <div class="pathway-card" onclick="app.showScreen('analyticsHome')" style="background: rgba(255,255,255,0.1); padding: 40px 30px; border-radius: 15px; cursor: pointer; transition: all 0.3s; border: 2px solid transparent; text-align: center;">
                        <div style="font-size: 4em; margin-bottom: 20px;">üìä</div>
                        <h2 style="margin-bottom: 15px; font-size: 1.5em;">View Analytics</h2>
                        <p style="color: rgba(255,255,255,0.8); margin-bottom: 20px;">
                            Explore collected data and generate research insights
                        </p>
                        <div style="background: rgba(102,126,234,0.3); padding: 8px 16px; border-radius: 20px; display: inline-block; font-size: 0.9em;">
                            Charts & Statistics
                        </div>
                    </div>
                </div>
                
                <!-- Quick Stats Bar -->
                <div style="display: flex; justify-content: center; gap: 40px; margin: 30px 0; padding: 20px; background: rgba(255,255,255,0.1); border-radius: 10px; max-width: 600px; margin-left: auto; margin-right: auto;">
                    <div style="text-align: center;">
                        <div id="statParticipants" style="font-size: 2em; font-weight: bold; color: #4ade80;">--</div>
                        <div style="font-size: 0.85em; opacity: 0.8;">Participants</div>
                    </div>
                    <div style="text-align: center;">
                        <div id="statSessions" style="font-size: 2em; font-weight: bold; color: #60a5fa;">--</div>
                        <div style="font-size: 0.85em; opacity: 0.8;">Sessions</div>
                    </div>
                    <div style="text-align: center;">
                        <div id="statTests" style="font-size: 2em; font-weight: bold; color: #fbbf24;">--</div>
                        <div style="font-size: 0.85em; opacity: 0.8;">Test Runs</div>
                    </div>
                </div>

                <!-- System Status (collapsed) -->
                <div style="max-width: 600px; margin: 20px auto;">
                    <div style="display: flex; justify-content: center; gap: 30px; font-size: 0.9em;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span>üéß Audio</span>
                            <span style="color: #4ade80;">Ready</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span>‚ö° Input</span>
                            <span id="hardwareStatus" style="color: #fbbf24;">Checking...</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span>üíæ Database</span>
                            <span id="dbStatus" style="color: #fbbf24;">Checking...</span>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 40px; padding-top: 30px; border-top: 1px solid rgba(255,255,255,0.2); font-size: 0.9em; color: rgba(255,255,255,0.8);">
                    <p><strong>Research Project by:</strong></p>
                    <p>Corey Ashcroft, Millie Kehoe, and Harry Quinlan</p>
                    <p>St Mary's Secondary School, Edenderry, Co. Offaly</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Analytics Home Screen -->
    <div id="analyticsHome" class="screen hidden">
        <div class="container" style="max-width: 1200px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <h1>üìä Analytics Dashboard</h1>
                <button class="btn btn-secondary" onclick="app.showScreen('welcomeScreen')">‚Üê Back to Home</button>
            </div>
            
            <!-- Analytics Navigation -->
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px;">
                <div class="analytics-nav-card selected" data-section="overview" onclick="app.showAnalyticsSection('overview')" style="background: rgba(74, 222, 128, 0.2); border: 2px solid #4ade80; padding: 20px; border-radius: 10px; cursor: pointer; text-align: center;">
                    <div style="font-size: 2em; margin-bottom: 10px;">üìà</div>
                    <div style="font-weight: bold;">Overview</div>
                </div>
                <div class="analytics-nav-card" data-section="music-effects" onclick="app.showAnalyticsSection('music-effects')" style="background: rgba(255,255,255,0.1); border: 2px solid transparent; padding: 20px; border-radius: 10px; cursor: pointer; text-align: center;">
                    <div style="font-size: 2em; margin-bottom: 10px;">üéµ</div>
                    <div style="font-weight: bold;">Music Effects</div>
                </div>
                <div class="analytics-nav-card" data-section="individual-diff" onclick="app.showAnalyticsSection('individual-diff')" style="background: rgba(255,255,255,0.1); border: 2px solid transparent; padding: 20px; border-radius: 10px; cursor: pointer; text-align: center;">
                    <div style="font-size: 2em; margin-bottom: 10px;">üë•</div>
                    <div style="font-weight: bold;">Individual Differences</div>
                </div>
                <div class="analytics-nav-card" data-section="test-details" onclick="app.showAnalyticsSection('test-details')" style="background: rgba(255,255,255,0.1); border: 2px solid transparent; padding: 20px; border-radius: 10px; cursor: pointer; text-align: center;">
                    <div style="font-size: 2em; margin-bottom: 10px;">üß†</div>
                    <div style="font-weight: bold;">Test Deep Dives</div>
                </div>
                <div class="analytics-nav-card" data-section="participants" onclick="app.showAnalyticsSection('participants')" style="background: rgba(255,255,255,0.1); border: 2px solid transparent; padding: 20px; border-radius: 10px; cursor: pointer; text-align: center;">
                    <div style="font-size: 2em; margin-bottom: 10px;">üë§</div>
                    <div style="font-weight: bold;">Participant Explorer</div>
                </div>
                <div class="analytics-nav-card" data-section="export" onclick="app.showAnalyticsSection('export')" style="background: rgba(255,255,255,0.1); border: 2px solid transparent; padding: 20px; border-radius: 10px; cursor: pointer; text-align: center;">
                    <div style="font-size: 2em; margin-bottom: 10px;">üì§</div>
                    <div style="font-weight: bold;">Export Data</div>
                </div>
            </div>
            
            <!-- Analytics Content Area -->
            <div id="analyticsContent" style="background: rgba(255,255,255,0.1); border-radius: 15px; padding: 30px; min-height: 500px;">
                <!-- Content loaded dynamically -->
                <div id="analyticsLoading" style="text-align: center; padding: 50px;">
                    <div class="loading-spinner" style="width: 50px; height: 50px; border: 5px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: #4ade80; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
                    <p>Loading analytics data...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Participant Information Screen -->
    <div id="participantScreen" class="screen hidden">
        <div class="form-container">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h2 style="margin-bottom: 0;">Participant Information</h2>
                <div style="text-align: right;">
                    <div style="font-size: 0.85em; color: #ffffff; margin-bottom: 3px;">Participant ID</div>
                    <div id="displayParticipantId" style="font-size: 1.8em; font-weight: bold; color: #ffffff; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); font-family: 'Courier New', monospace;">P000000</div>
                </div>
            </div>
            <p style="margin-bottom: 15px; color: #ffffff; font-size: 0.9em; text-shadow: 1px 1px 2px rgba(0,0,0,0.4);">Please complete all required fields marked with *</p>
            
            <form id="participantForm" class="participant-form">
                <!-- Row 1: Basic Info -->
                <div class="form-row-3col">
                    <div class="form-group">
                        <label for="ageCategory">Age Category *</label>
                        <select id="ageCategory" required>
                            <option value="">Select...</option>
                            <option value="10-20">10-20</option>
                            <option value="20-30">20-30</option>
                            <option value="30-40">30-40</option>
                            <option value="40-50">40-50</option>
                            <option value="50+">50+</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="gender">Gender</label>
                        <select id="gender">
                            <option value="">Select...</option>
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                            <option value="non-binary">Non-binary</option>
                            <option value="prefer-not-to-say">Prefer not to say</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="dominantHand">Dominant Hand *</label>
                        <select id="dominantHand" required>
                            <option value="">Select...</option>
                            <option value="right">Right</option>
                            <option value="left">Left</option>
                        </select>
                    </div>
                </div>
                
                <!-- Row 2: Musical Background -->
                <div class="form-row-3col">
                    <div class="form-group">
                        <label for="musicalBackground">Musical Background *</label>
                        <select id="musicalBackground" required>
                            <option value="">Select...</option>
                            <option value="none">No musical training</option>
                            <option value="casual">Casual (self-taught, hobby)</option>
                            <option value="some-lessons">Some lessons (1-3 years)</option>
                            <option value="moderate">Moderate (4-7 years)</option>
                            <option value="extensive">Extensive (8+ years)</option>
                            <option value="professional">Professional musician</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="currentMusicEngagement">Current Music Engagement *</label>
                        <select id="currentMusicEngagement" required>
                            <option value="">Select...</option>
                            <option value="none">Rarely listen to music</option>
                            <option value="occasional">Occasional (few times/week)</option>
                            <option value="daily">Daily listener (1-2 hours/day)</option>
                            <option value="frequent">Frequent (3+ hours/day)</option>
                            <option value="active">Active player (practice/perform)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="hearingImpairment">Hearing Impairment *</label>
                        <select id="hearingImpairment" required>
                            <option value="">Select...</option>
                            <option value="none">None</option>
                            <option value="mild">Mild</option>
                            <option value="moderate">Moderate</option>
                            <option value="severe">Severe</option>
                        </select>
                    </div>
                </div>

                <!-- Row 3: Sleep -->
                <div class="form-row-3col">
                    <div class="form-group">
                        <label for="sleepHours">Hours of Sleep Last Night</label>
                        <input type="number" id="sleepHours" min="0" max="24" step="0.5" placeholder="e.g., 7.5">
                    </div>
                    <div class="form-group"></div>
                    <div class="form-group"></div>
                </div>

                <!-- Row 4: Caffeine & Medications -->
                <div class="form-row-3col">
                    <div class="form-group">
                        <label for="caffeineSource">Caffeine Source Today</label>
                        <select id="caffeineSource">
                            <option value="none">None</option>
                            <option value="coffee">Coffee</option>
                            <option value="tea">Tea</option>
                            <option value="energy-drink">Energy Drink</option>
                            <option value="soda">Caffeinated Soda</option>
                            <option value="multiple">Multiple Sources</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="caffeineAmount">Caffeine Amount</label>
                        <select id="caffeineAmount">
                            <option value="none">None</option>
                            <option value="low">Low (~50-100mg)</option>
                            <option value="moderate">Moderate (~100-200mg)</option>
                            <option value="high">High (~200-400mg)</option>
                            <option value="very-high">Very High (400mg+)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="medications">Current Medications</label>
                        <textarea id="medications" rows="2" placeholder="List medications or 'None'"></textarea>
                    </div>
                </div>

                <!-- Notes -->
                <div class="form-group full-width-section">
                    <label for="notes">Additional Notes</label>
                    <textarea id="notes" rows="2" placeholder="Any additional information..."></textarea>
                </div>

                <div class="button-group">
                    <button type="button" class="btn btn-secondary" onclick="app.showScreen('welcomeScreen')">
                        Back
                    </button>
                    <button type="button" class="btn btn-primary" onclick="app.handleParticipantSubmit()">
                        Continue to Test Selection
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Test Suite Selection Screen -->
    <div id="testSelectionScreen" class="screen hidden">
        <div class="container" style="max-width: 1000px;">
            <h2>Select Test Suite</h2>
            <p style="text-align: center; margin-bottom: 20px; color: #ffffff;">
                Choose one or both test suites for this session
            </p>

            <div id="sessionInfo" class="info-box"></div>

            <!-- Test Suites -->
            <div class="suite-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 30px 0;">
                
                <!-- Suite 1: Reaction & Inhibition -->
                <div class="suite-card selected" data-suite="reaction-inhibition" onclick="app.toggleSuite(this)" style="background: rgba(74, 222, 128, 0.2); border: 2px solid #4ade80; padding: 25px; border-radius: 12px; cursor: pointer;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin: 0;">‚ö° Reaction & Inhibition</h3>
                        <span style="background: rgba(255,255,255,0.2); padding: 5px 12px; border-radius: 15px; font-size: 0.9em;">~17 min</span>
                    </div>
                    <p style="color: rgba(255,255,255,0.8); margin-bottom: 15px; font-size: 0.95em;">
                        Processing speed, response inhibition, and selective attention
                    </p>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <div style="display: flex; justify-content: space-between; background: rgba(255,255,255,0.1); padding: 8px 12px; border-radius: 6px;">
                            <span>‚ö° Simple Reaction Time</span>
                            <span style="opacity: 0.7;">1 min</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; background: rgba(255,255,255,0.1); padding: 8px 12px; border-radius: 6px;">
                            <span>üö¶ Go/No-Go Task</span>
                            <span style="opacity: 0.7;">1.5 min</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; background: rgba(255,255,255,0.1); padding: 8px 12px; border-radius: 6px;">
                            <span>üåà Stroop Test</span>
                            <span style="opacity: 0.7;">1.5 min</span>
                        </div>
                    </div>
                    <div style="margin-top: 15px; display: flex; gap: 8px; flex-wrap: wrap;">
                        <span style="background: rgba(255,107,107,0.3); padding: 4px 10px; border-radius: 12px; font-size: 0.8em;">Processing Speed</span>
                        <span style="background: rgba(255,107,107,0.3); padding: 4px 10px; border-radius: 12px; font-size: 0.8em;">Response Inhibition</span>
                        <span style="background: rgba(255,107,107,0.3); padding: 4px 10px; border-radius: 12px; font-size: 0.8em;">Cognitive Control</span>
                    </div>
                </div>

                <!-- Suite 2: Cognitive Load -->
                <div class="suite-card" data-suite="cognitive-load" onclick="app.toggleSuite(this)" style="background: rgba(255,255,255,0.1); border: 2px solid transparent; padding: 25px; border-radius: 12px; cursor: pointer;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin: 0;">üß† Cognitive Load</h3>
                        <span style="background: rgba(255,255,255,0.2); padding: 5px 12px; border-radius: 15px; font-size: 0.9em;">~17 min</span>
                    </div>
                    <p style="color: rgba(255,255,255,0.8); margin-bottom: 15px; font-size: 0.95em;">
                        Decision making, working memory capacity, and memory updating
                    </p>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <div style="display: flex; justify-content: space-between; background: rgba(255,255,255,0.1); padding: 8px 12px; border-radius: 6px;">
                            <span>üéØ Choice Reaction Time</span>
                            <span style="opacity: 0.7;">1.5 min</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; background: rgba(255,255,255,0.1); padding: 8px 12px; border-radius: 6px;">
                            <span>üî¢ Digit Span</span>
                            <span style="opacity: 0.7;">2 min</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; background: rgba(255,255,255,0.1); padding: 8px 12px; border-radius: 6px;">
                            <span>üîÑ N-Back (2-Back)</span>
                            <span style="opacity: 0.7;">2 min</span>
                        </div>
                    </div>
                    <div style="margin-top: 15px; display: flex; gap: 8px; flex-wrap: wrap;">
                        <span style="background: rgba(102,126,234,0.3); padding: 4px 10px; border-radius: 12px; font-size: 0.8em;">Decision Speed</span>
                        <span style="background: rgba(102,126,234,0.3); padding: 4px 10px; border-radius: 12px; font-size: 0.8em;">Working Memory</span>
                        <span style="background: rgba(102,126,234,0.3); padding: 4px 10px; border-radius: 12px; font-size: 0.8em;">Memory Updating</span>
                    </div>
                </div>
            </div>

            <!-- Time Estimate -->
            <div class="info-box" style="text-align: center;">
                <div style="font-size: 1.2em; margin-bottom: 5px;">
                    <span>Estimated Session Time: </span>
                    <strong id="estimatedTime">~17 minutes</strong>
                </div>
                <div id="timeBreakdown" style="opacity: 0.8; font-size: 0.9em;">
                    3 tests √ó 3 music conditions + transitions
                </div>
            </div>

            <!-- Music Conditions -->
            <div class="info-box">
                <h4 style="margin-bottom: 10px;">Music Conditions (within-subjects design)</h4>
                <div style="display: flex; gap: 20px; justify-content: center; flex-wrap: wrap;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 1.5em;">üîá</span>
                        <span>Silence</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 1.5em;">üéª</span>
                        <span>Classical</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 1.5em;">üéß</span>
                        <span>Electronic</span>
                    </div>
                </div>
                <p style="text-align: center; margin-top: 10px; opacity: 0.8; font-size: 0.9em;">
                    Each participant completes all tests under all 3 conditions (counterbalanced order)
                </p>
            </div>

            <div class="button-group">
                <button class="btn btn-secondary" onclick="app.showScreen('participantScreen')">
                    Back
                </button>
                <button class="btn btn-primary" onclick="app.startTestBattery()">
                    Start Testing Session
                </button>
            </div>
        </div>
    </div>

    <!-- Test Execution Screen -->
    <div id="testScreen" class="screen hidden">
        <div class="container" style="text-align: center;">
            <h2 id="testTitle">Test in Progress</h2>
            
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%;">0%</div>
                </div>
            </div>

            <div style="margin: 20px auto; display: flex; justify-content: center;">
                <canvas id="testCanvas" width="800" height="500" style="background: #1a1a2e; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.5);"></canvas>
            </div>

            <div class="info-box" id="testInstructions">
                Test instructions will appear here
            </div>

            <div class="button-group">
                <button class="btn btn-secondary" onclick="app.pauseTest()">
                    Pause
                </button>
                <button class="btn btn-secondary" onclick="app.skipTest()">
                    Skip Test
                </button>
            </div>
        </div>
    </div>

    <!-- Results Screen -->
    <div id="resultsScreen" class="screen hidden">
        <div class="results-container">
            <h2>Session Results</h2>
            
            <div id="sessionSummary" class="info-box"></div>

            <div class="metric-grid" id="metricsDisplay">
                <div class="metric-card">
                    <div class="metric-label">Avg Reaction Time</div>
                    <div class="metric-value" id="avgRT">--</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Accuracy</div>
                    <div class="metric-value" id="accuracy">--</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Tests Completed</div>
                    <div class="metric-value" id="testsCompleted">--</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Total Trials</div>
                    <div class="metric-value" id="totalTrials">--</div>
                </div>
            </div>

            <div class="info-box">
                <h3>Performance Summary</h3>
                <div id="performanceSummary"></div>
            </div>

            <div class="button-group">
                <button class="btn btn-secondary" onclick="app.exportResults()">
                    Export Data
                </button>
                <button class="btn btn-primary" onclick="app.startNewSession()">
                    Start New Session
                </button>
            </div>
        </div>
    </div>

    <script>
        // Import ipcRenderer for database and hardware communication
        const { ipcRenderer } = require('electron');
        
        // Main Application Object
        const app = {
            currentScreen: 'welcomeScreen',
            currentSession: null,
            currentParticipantId: null,
            currentParticipantDbId: null,
            currentSessionDbId: null,
            selectedTests: [],
            testResults: {},
            canvas: null,
            ctx: null,
            dbReady: false,
            hardwareReady: false,
            
        // Test suite definitions
        testSuites: {
            'reaction-inhibition': {
                name: 'Reaction & Inhibition',
                tests: ['simple-reaction', 'go-nogo', 'stroop'],
                duration: 17
            },
            'cognitive-load': {
                name: 'Cognitive Load', 
                tests: ['choice-reaction', 'digit-span', 'n-back'],
                duration: 17
            }
        },
        
        // Music conditions (within-subjects)
        musicConditions: ['silence', 'classical', 'electronic'],
        
        selectedSuites: ['reaction-inhibition'], // Default to first suite
        testQueue: [],
        testIndex: 0,
        
        async init() {
            console.log('Initializing Music & Cognition Research Platform...');
            this.canvas = document.getElementById('testCanvas');
            if (this.canvas) {
                this.ctx = this.canvas.getContext('2d');
            }
            this.setupEventListeners();
            await this.checkSystems();
            await this.loadHomeStats();
        },

            async checkSystems() {
                // Check database
                try {
                    const result = await ipcRenderer.invoke('db:getNextParticipantCode');
                    if (result.success) {
                        this.dbReady = true;
                        document.getElementById('dbStatus').textContent = 'Ready';
                        document.getElementById('dbStatus').style.color = '#4ade80';
                        console.log('‚úÖ Database connected');
                    } else {
                        throw new Error(result.error);
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è Database not available:', error);
                    document.getElementById('dbStatus').textContent = 'Offline';
                    document.getElementById('dbStatus').style.color = '#f87171';
                    this.dbReady = false;
                }
                
                // Check hardware
                try {
                    const status = await ipcRenderer.invoke('get-hardware-status');
                    if (status.connected) {
                        this.hardwareReady = true;
                        document.getElementById('hardwareStatus').textContent = 'Connected';
                        document.getElementById('hardwareStatus').style.color = '#4ade80';
                    } else {
                        document.getElementById('hardwareStatus').textContent = 'Keyboard Mode';
                        document.getElementById('hardwareStatus').style.color = '#fbbf24';
                    }
                } catch (error) {
                    document.getElementById('hardwareStatus').textContent = 'Keyboard Mode';
                    document.getElementById('hardwareStatus').style.color = '#fbbf24';
                }
            },

            // ========================================
            // HOMEPAGE STATS
            // ========================================
            
            async loadHomeStats() {
                if (!this.dbReady) {
                    document.getElementById('statParticipants').textContent = '0';
                    document.getElementById('statSessions').textContent = '0';
                    document.getElementById('statTests').textContent = '0';
                    return;
                }
                
                try {
                    const stats = await ipcRenderer.invoke('db:getOverviewStats');
                    if (stats.success) {
                        document.getElementById('statParticipants').textContent = stats.result.participants || 0;
                        document.getElementById('statSessions').textContent = stats.result.sessions || 0;
                        document.getElementById('statTests').textContent = stats.result.testRuns || 0;
                    }
                } catch (error) {
                    console.error('Error loading stats:', error);
                }
            },

            // ========================================
            // ANALYTICS NAVIGATION
            // ========================================
            
            currentAnalyticsSection: 'overview',
            analyticsData: null,
            
            async showAnalyticsSection(section) {
                this.currentAnalyticsSection = section;
                
                // Update nav styling
                document.querySelectorAll('.analytics-nav-card').forEach(card => {
                    if (card.dataset.section === section) {
                        card.style.background = 'rgba(74, 222, 128, 0.2)';
                        card.style.borderColor = '#4ade80';
                    } else {
                        card.style.background = 'rgba(255,255,255,0.1)';
                        card.style.borderColor = 'transparent';
                    }
                });
                
                // Show loading
                const content = document.getElementById('analyticsContent');
                content.innerHTML = `
                    <div style="text-align: center; padding: 50px;">
                        <div style="width: 50px; height: 50px; border: 5px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: #4ade80; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
                        <p>Loading ${section} data...</p>
                    </div>
                `;
                
                // Load section
                switch (section) {
                    case 'overview':
                        await this.renderOverviewSection();
                        break;
                    case 'music-effects':
                        await this.renderMusicEffectsSection();
                        break;
                    case 'individual-diff':
                        await this.renderIndividualDiffSection();
                        break;
                    case 'test-details':
                        await this.renderTestDetailsSection();
                        break;
                    case 'participants':
                        await this.renderParticipantsSection();
                        break;
                    case 'export':
                        await this.renderExportSection();
                        break;
                }
            },

            // ========================================
            // OVERVIEW SECTION
            // ========================================
            
            async renderOverviewSection() {
                const content = document.getElementById('analyticsContent');
                
                if (!this.dbReady) {
                    content.innerHTML = `
                        <div style="text-align: center; padding: 50px;">
                            <div style="font-size: 4em; margin-bottom: 20px;">‚ö†Ô∏è</div>
                            <h3>Database Not Connected</h3>
                            <p>Please ensure the database is initialized to view analytics.</p>
                        </div>
                    `;
                    return;
                }
                
                try {
                    // Fetch all overview data
                    const [statsResult, conditionResult, participantsResult, timeSeriesResult, cumulativeResult] = await Promise.all([
                        ipcRenderer.invoke('db:getOverviewStats'),
                        ipcRenderer.invoke('db:getConditionSummary'),
                        ipcRenderer.invoke('db:getAllParticipants'),
                        ipcRenderer.invoke('db:getTimeSeriesData'),
                        ipcRenderer.invoke('db:getCumulativeParticipants')
                    ]);
                    
                    const stats = statsResult.success ? statsResult.result : {};
                    const conditionData = conditionResult.success ? conditionResult.result : [];
                    const participants = participantsResult.success ? participantsResult.result : [];
                    const timeSeriesData = timeSeriesResult.success ? timeSeriesResult.result : [];
                    const cumulativeData = cumulativeResult.success ? cumulativeResult.result : [];
                    
                    content.innerHTML = `
                        <h2 style="margin-bottom: 25px;">üìà Overview Dashboard</h2>
                        
                        <!-- Summary Cards -->
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px;">
                            <div style="background: rgba(74, 222, 128, 0.2); padding: 25px; border-radius: 12px; text-align: center;">
                                <div style="font-size: 2.5em; font-weight: bold; color: #4ade80;">${stats.participants || 0}</div>
                                <div style="opacity: 0.8;">Participants</div>
                            </div>
                            <div style="background: rgba(96, 165, 250, 0.2); padding: 25px; border-radius: 12px; text-align: center;">
                                <div style="font-size: 2.5em; font-weight: bold; color: #60a5fa;">${stats.sessions || 0}</div>
                                <div style="opacity: 0.8;">Sessions</div>
                            </div>
                            <div style="background: rgba(251, 191, 36, 0.2); padding: 25px; border-radius: 12px; text-align: center;">
                                <div style="font-size: 2.5em; font-weight: bold; color: #fbbf24;">${stats.testRuns || 0}</div>
                                <div style="opacity: 0.8;">Test Runs</div>
                            </div>
                            <div style="background: rgba(244, 114, 182, 0.2); padding: 25px; border-radius: 12px; text-align: center;">
                                <div style="font-size: 2.5em; font-weight: bold; color: #f472b6;">${stats.totalTrials || 0}</div>
                                <div style="opacity: 0.8;">Total Trials</div>
                            </div>
                        </div>
                        
                        <!-- Time Series Chart -->
                        <div style="background: rgba(255,255,255,0.05); padding: 25px; border-radius: 12px; margin-bottom: 20px;">
                            <h3 style="margin-bottom: 20px;">üìÖ Data Collection Timeline</h3>
                            ${this.renderTimeSeriesChart(cumulativeData, timeSeriesData)}
                        </div>
                        
                        <!-- Condition Comparison Chart -->
                        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px;">
                            <div style="background: rgba(255,255,255,0.05); padding: 25px; border-radius: 12px;">
                                <h3 style="margin-bottom: 20px;">üéµ Performance by Music Condition</h3>
                                <div id="conditionChart" style="height: 250px;">
                                    ${this.renderConditionChart(conditionData)}
                                </div>
                            </div>
                            
                            <div style="background: rgba(255,255,255,0.05); padding: 25px; border-radius: 12px;">
                                <h3 style="margin-bottom: 20px;">üë• Participant Demographics</h3>
                                ${this.renderDemographicsSummary(participants)}
                            </div>
                        </div>
                        
                        <!-- Recent Activity -->
                        <div style="margin-top: 20px; background: rgba(255,255,255,0.05); padding: 25px; border-radius: 12px;">
                            <h3 style="margin-bottom: 15px;">üïê Recent Participants</h3>
                            ${this.renderRecentParticipants(participants.slice(0, 5))}
                        </div>
                    `;
                    
                } catch (error) {
                    console.error('Error loading overview:', error);
                    content.innerHTML = `
                        <div style="text-align: center; padding: 50px;">
                            <div style="font-size: 4em; margin-bottom: 20px;">‚ùå</div>
                            <h3>Error Loading Data</h3>
                            <p>${error.message}</p>
                        </div>
                    `;
                }
            },
            
            renderTimeSeriesChart(cumulativeData, dailyData) {
                if (!cumulativeData || cumulativeData.length === 0) {
                    return '<p style="text-align: center; opacity: 0.6; padding: 30px;">No data collection history yet. Run some sessions to see the timeline.</p>';
                }
                
                const maxCount = Math.max(...cumulativeData.map(d => d.cumulative_count || 0), 1);
                const chartWidth = 100; // percentage
                
                let html = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                        <!-- Cumulative Participants Line Chart -->
                        <div>
                            <h4 style="margin-bottom: 15px; opacity: 0.8;">Cumulative Participants</h4>
                            <div style="position: relative; height: 200px; border-left: 2px solid rgba(255,255,255,0.3); border-bottom: 2px solid rgba(255,255,255,0.3); padding: 10px;">
                                <svg width="100%" height="100%" viewBox="0 0 400 180" preserveAspectRatio="none">
                                    <defs>
                                        <linearGradient id="lineGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                                            <stop offset="0%" style="stop-color:#4ade80;stop-opacity:0.3" />
                                            <stop offset="100%" style="stop-color:#4ade80;stop-opacity:0" />
                                        </linearGradient>
                                    </defs>
                `;
                
                // Build line path
                const points = cumulativeData.map((d, i) => {
                    const x = (i / Math.max(cumulativeData.length - 1, 1)) * 380 + 10;
                    const y = 170 - ((d.cumulative_count || 0) / maxCount) * 160;
                    return `${x},${y}`;
                });
                
                // Area fill
                const areaPath = `M10,170 L${points.join(' L')} L${380},170 Z`;
                html += `<path d="${areaPath}" fill="url(#lineGradient)" />`;
                
                // Line
                html += `<polyline points="${points.join(' ')}" fill="none" stroke="#4ade80" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" />`;
                
                // Data points
                cumulativeData.forEach((d, i) => {
                    const x = (i / Math.max(cumulativeData.length - 1, 1)) * 380 + 10;
                    const y = 170 - ((d.cumulative_count || 0) / maxCount) * 160;
                    html += `<circle cx="${x}" cy="${y}" r="5" fill="#4ade80" />`;
                });
                
                html += `
                                </svg>
                                <!-- Y-axis labels -->
                                <div style="position: absolute; left: -35px; top: 0; font-size: 11px; opacity: 0.7;">${maxCount}</div>
                                <div style="position: absolute; left: -25px; bottom: 0; font-size: 11px; opacity: 0.7;">0</div>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-top: 5px; font-size: 11px; opacity: 0.7;">
                                <span>${cumulativeData[0]?.date || ''}</span>
                                <span>${cumulativeData[cumulativeData.length - 1]?.date || ''}</span>
                            </div>
                        </div>
                        
                        <!-- Daily Activity Bar Chart -->
                        <div>
                            <h4 style="margin-bottom: 15px; opacity: 0.8;">Daily Sessions</h4>
                            <div style="height: 200px; display: flex; align-items: flex-end; gap: 4px; padding-bottom: 25px;">
                `;
                
                const maxDaily = Math.max(...(dailyData.map(d => d.sessions || 0)), 1);
                const recentDays = dailyData.slice(-14); // Last 14 days
                
                recentDays.forEach(d => {
                    const height = ((d.sessions || 0) / maxDaily) * 150;
                    const date = d.date ? new Date(d.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : '';
                    html += `
                        <div style="flex: 1; display: flex; flex-direction: column; align-items: center;">
                            <div style="font-size: 10px; margin-bottom: 3px;">${d.sessions || 0}</div>
                            <div style="width: 100%; height: ${Math.max(height, 4)}px; background: linear-gradient(to top, #60a5fa, #a78bfa); border-radius: 4px 4px 0 0;"></div>
                            <div style="font-size: 9px; margin-top: 5px; opacity: 0.6; transform: rotate(-45deg); white-space: nowrap;">${date}</div>
                        </div>
                    `;
                });
                
                html += `
                            </div>
                        </div>
                    </div>
                    
                    <!-- Summary stats -->
                    <div style="display: flex; justify-content: center; gap: 40px; margin-top: 20px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1);">
                        <div style="text-align: center;">
                            <span style="opacity: 0.7;">Total Days Active:</span>
                            <strong style="margin-left: 8px;">${cumulativeData.length}</strong>
                        </div>
                        <div style="text-align: center;">
                            <span style="opacity: 0.7;">Avg Participants/Day:</span>
                            <strong style="margin-left: 8px;">${(cumulativeData.length > 0 ? (cumulativeData[cumulativeData.length-1]?.cumulative_count || 0) / cumulativeData.length : 0).toFixed(1)}</strong>
                        </div>
                        <div style="text-align: center;">
                            <span style="opacity: 0.7;">Best Day:</span>
                            <strong style="margin-left: 8px;">${Math.max(...cumulativeData.map(d => d.daily_count || 0))} participants</strong>
                        </div>
                    </div>
                `;
                
                return html;
            },
            
            renderConditionChart(data) {
                if (!data || data.length === 0) {
                    return '<p style="text-align: center; opacity: 0.6;">No data available yet. Run some test sessions to see results.</p>';
                }
                
                // Find max values for scaling
                const maxRT = Math.max(...data.map(d => d.mean_rt || 0), 500);
                
                let chartHTML = '<div style="display: flex; align-items: flex-end; justify-content: space-around; height: 200px; padding: 20px 0;">';
                
                const conditionColors = {
                    'silence': '#94a3b8',
                    'classical': '#a78bfa',
                    'electronic': '#34d399'
                };
                
                data.forEach(d => {
                    const barHeight = ((d.mean_rt || 0) / maxRT) * 150;
                    const color = conditionColors[d.music_condition] || '#60a5fa';
                    
                    chartHTML += `
                        <div style="text-align: center; flex: 1; max-width: 150px;">
                            <div style="font-weight: bold; margin-bottom: 5px;">${Math.round(d.mean_rt || 0)} ms</div>
                            <div style="height: ${barHeight}px; background: ${color}; border-radius: 8px 8px 0 0; margin: 0 20px;"></div>
                            <div style="margin-top: 10px; font-size: 0.9em;">${this.formatConditionName(d.music_condition)}</div>
                            <div style="font-size: 0.8em; opacity: 0.7;">${d.accuracy ? Math.round(d.accuracy) + '% acc' : ''}</div>
                        </div>
                    `;
                });
                
                chartHTML += '</div>';
                return chartHTML;
            },
            
            formatConditionName(condition) {
                const names = {
                    'silence': 'üîá Silence',
                    'classical': 'üéª Classical',
                    'electronic': 'üéß Electronic'
                };
                return names[condition] || condition;
            },
            
            renderDemographicsSummary(participants) {
                if (!participants || participants.length === 0) {
                    return '<p style="opacity: 0.6;">No participants yet.</p>';
                }
                
                // Count by musical background
                const musicBg = {};
                participants.forEach(p => {
                    const bg = p.musical_background || 'unknown';
                    musicBg[bg] = (musicBg[bg] || 0) + 1;
                });
                
                let html = '<div style="font-size: 0.9em;">';
                Object.entries(musicBg).forEach(([bg, count]) => {
                    const pct = Math.round((count / participants.length) * 100);
                    html += `
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span>${this.formatMusicalBackground(bg)}</span>
                            <span>${count} (${pct}%)</span>
                        </div>
                        <div style="background: rgba(255,255,255,0.1); height: 6px; border-radius: 3px; margin-bottom: 12px;">
                            <div style="background: #60a5fa; height: 100%; width: ${pct}%; border-radius: 3px;"></div>
                        </div>
                    `;
                });
                html += '</div>';
                return html;
            },
            
            formatMusicalBackground(bg) {
                const names = {
                    'none': 'No Training',
                    'casual': 'Casual',
                    'some-lessons': 'Some Lessons',
                    'moderate': 'Moderate',
                    'extensive': 'Extensive',
                    'professional': 'Professional'
                };
                return names[bg] || bg;
            },
            
            renderRecentParticipants(participants) {
                if (!participants || participants.length === 0) {
                    return '<p style="opacity: 0.6;">No participants yet.</p>';
                }
                
                let html = '<table style="width: 100%; border-collapse: collapse;">';
                html += '<tr style="border-bottom: 1px solid rgba(255,255,255,0.2);"><th style="text-align: left; padding: 10px;">ID</th><th>Age</th><th>Musical Background</th><th>Date</th></tr>';
                
                participants.forEach(p => {
                    const date = p.created_at ? new Date(p.created_at).toLocaleDateString() : '--';
                    html += `
                        <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                            <td style="padding: 10px;">${p.participant_code}</td>
                            <td style="text-align: center;">${p.age_category || '--'}</td>
                            <td style="text-align: center;">${this.formatMusicalBackground(p.musical_background)}</td>
                            <td style="text-align: center;">${date}</td>
                        </tr>
                    `;
                });
                
                html += '</table>';
                return html;
            },

            // ========================================
            // MUSIC EFFECTS SECTION
            // ========================================
            
            async renderMusicEffectsSection() {
                const content = document.getElementById('analyticsContent');
                
                if (!this.dbReady) {
                    content.innerHTML = '<div style="text-align: center; padding: 50px;"><h3>Database not connected</h3></div>';
                    return;
                }
                
                try {
                    const [conditionResult, testTypeResult] = await Promise.all([
                        ipcRenderer.invoke('db:getConditionSummary'),
                        ipcRenderer.invoke('db:getTestTypeSummary')
                    ]);
                    
                    const conditionData = conditionResult.success ? conditionResult.result : [];
                    const testTypeData = testTypeResult.success ? testTypeResult.result : [];
                    
                    content.innerHTML = `
                        <h2 style="margin-bottom: 25px;">üéµ Music Effects Analysis</h2>
                        
                        <!-- Overall Condition Comparison -->
                        <div style="background: rgba(255,255,255,0.05); padding: 25px; border-radius: 12px; margin-bottom: 20px;">
                            <h3 style="margin-bottom: 20px;">Overall Performance by Condition</h3>
                            ${this.renderDetailedConditionTable(conditionData)}
                        </div>
                        
                        <!-- By Test Type -->
                        <div style="background: rgba(255,255,255,0.05); padding: 25px; border-radius: 12px; margin-bottom: 20px;">
                            <h3 style="margin-bottom: 20px;">Performance by Test Type</h3>
                            ${this.renderTestTypeTable(testTypeData)}
                        </div>
                        
                        <!-- Effect Sizes -->
                        <div style="background: rgba(255,255,255,0.05); padding: 25px; border-radius: 12px;">
                            <h3 style="margin-bottom: 20px;">Effect Size Summary</h3>
                            ${this.renderEffectSizes(conditionData)}
                        </div>
                    `;
                    
                } catch (error) {
                    content.innerHTML = `<div style="text-align: center; padding: 50px;"><h3>Error: ${error.message}</h3></div>`;
                }
            },
            
            renderDetailedConditionTable(data) {
                if (!data || data.length === 0) {
                    return '<p style="opacity: 0.6;">No data available.</p>';
                }
                
                let html = '<table style="width: 100%; border-collapse: collapse;">';
                html += `<tr style="border-bottom: 2px solid rgba(255,255,255,0.3);">
                    <th style="text-align: left; padding: 12px;">Condition</th>
                    <th style="text-align: center;">N (Tests)</th>
                    <th style="text-align: center;">Mean RT</th>
                    <th style="text-align: center;">Median RT</th>
                    <th style="text-align: center;">Accuracy</th>
                </tr>`;
                
                data.forEach(d => {
                    html += `
                        <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                            <td style="padding: 12px;">${this.formatConditionName(d.music_condition)}</td>
                            <td style="text-align: center;">${d.test_count || 0}</td>
                            <td style="text-align: center;">${d.mean_rt ? Math.round(d.mean_rt) + ' ms' : '--'}</td>
                            <td style="text-align: center;">${d.median_rt ? Math.round(d.median_rt) + ' ms' : '--'}</td>
                            <td style="text-align: center;">${d.accuracy ? d.accuracy.toFixed(1) + '%' : '--'}</td>
                        </tr>
                    `;
                });
                
                html += '</table>';
                return html;
            },
            
            renderTestTypeTable(data) {
                if (!data || data.length === 0) {
                    return '<p style="opacity: 0.6;">No data available.</p>';
                }
                
                let html = '<table style="width: 100%; border-collapse: collapse;">';
                html += `<tr style="border-bottom: 2px solid rgba(255,255,255,0.3);">
                    <th style="text-align: left; padding: 12px;">Test Type</th>
                    <th style="text-align: center;">N</th>
                    <th style="text-align: center;">Mean RT</th>
                    <th style="text-align: center;">Accuracy</th>
                </tr>`;
                
                data.forEach(d => {
                    html += `
                        <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                            <td style="padding: 12px;">${d.test_type}</td>
                            <td style="text-align: center;">${d.test_count || 0}</td>
                            <td style="text-align: center;">${d.mean_rt ? Math.round(d.mean_rt) + ' ms' : '--'}</td>
                            <td style="text-align: center;">${d.accuracy ? d.accuracy.toFixed(1) + '%' : '--'}</td>
                        </tr>
                    `;
                });
                
                html += '</table>';
                return html;
            },
            
            renderEffectSizes(data) {
                if (!data || data.length < 2) {
                    return '<p style="opacity: 0.6;">Need at least 2 conditions to calculate effect sizes.</p>';
                }
                
                // Find silence baseline
                const silence = data.find(d => d.music_condition === 'silence');
                if (!silence || !silence.mean_rt) {
                    return '<p style="opacity: 0.6;">Need silence condition as baseline.</p>';
                }
                
                let html = '<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">';
                
                data.filter(d => d.music_condition !== 'silence').forEach(d => {
                    const rtDiff = silence.mean_rt - (d.mean_rt || silence.mean_rt);
                    const pctChange = ((rtDiff / silence.mean_rt) * 100);
                    const direction = rtDiff > 0 ? 'faster' : 'slower';
                    const color = rtDiff > 0 ? '#4ade80' : '#f87171';
                    
                    html += `
                        <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 10px;">
                            <h4 style="margin-bottom: 10px;">${this.formatConditionName(d.music_condition)} vs Silence</h4>
                            <div style="font-size: 1.8em; font-weight: bold; color: ${color};">
                                ${Math.abs(pctChange).toFixed(1)}% ${direction}
                            </div>
                            <div style="font-size: 0.9em; opacity: 0.7; margin-top: 5px;">
                                ${Math.abs(Math.round(rtDiff))} ms difference
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                return html;
            },

            // ========================================
            // INDIVIDUAL DIFFERENCES SECTION
            // ========================================
            
            async renderIndividualDiffSection() {
                const content = document.getElementById('analyticsContent');
                
                if (!this.dbReady) {
                    content.innerHTML = '<div style="text-align: center; padding: 50px;"><h3>Database not connected</h3></div>';
                    return;
                }
                
                try {
                    const [bgResult, crossTab1Result, crossTab2Result] = await Promise.all([
                        ipcRenderer.invoke('db:getMusicalBackgroundComparison'),
                        ipcRenderer.invoke('db:getCrossTabulation', 'musical_background', 'music_condition'),
                        ipcRenderer.invoke('db:getCrossTabulation', 'age_category', 'music_condition')
                    ]);
                    
                    const data = bgResult.success ? bgResult.result : [];
                    const crossTab1 = crossTab1Result.success ? crossTab1Result.result : [];
                    const crossTab2 = crossTab2Result.success ? crossTab2Result.result : [];
                    
                    content.innerHTML = `
                        <h2 style="margin-bottom: 25px;">üë• Individual Differences Analysis</h2>
                        
                        <!-- Musical Background Comparison -->
                        <div style="background: rgba(255,255,255,0.05); padding: 25px; border-radius: 12px; margin-bottom: 20px;">
                            <h3 style="margin-bottom: 20px;">Performance by Musical Background</h3>
                            ${this.renderMusicalBackgroundTable(data)}
                        </div>
                        
                        <!-- Key Insight -->
                        <div style="background: rgba(102, 126, 234, 0.2); padding: 25px; border-radius: 12px; border-left: 4px solid #667eea; margin-bottom: 20px;">
                            <h4 style="margin-bottom: 10px;">üí° Research Question</h4>
                            <p style="opacity: 0.9;">Do participants with musical training respond differently to music conditions compared to those without training?</p>
                            ${this.renderMusicianVsNonMusicianInsight(data)}
                        </div>
                        
                        <!-- Cross-Tabulation Section -->
                        <div style="background: rgba(255,255,255,0.05); padding: 25px; border-radius: 12px; margin-bottom: 20px;">
                            <h3 style="margin-bottom: 20px;">üìä Cross-Tabulation: Musical Background √ó Music Condition</h3>
                            <p style="opacity: 0.7; margin-bottom: 15px;">Mean reaction time (ms) for each combination of musical background and music condition</p>
                            ${this.renderCrossTabHeatmap(crossTab1, 'musical_background', 'music_condition', 'mean_rt')}
                        </div>
                        
                        <!-- Age √ó Condition Cross-Tab -->
                        <div style="background: rgba(255,255,255,0.05); padding: 25px; border-radius: 12px; margin-bottom: 20px;">
                            <h3 style="margin-bottom: 20px;">üìä Cross-Tabulation: Age Category √ó Music Condition</h3>
                            <p style="opacity: 0.7; margin-bottom: 15px;">Mean reaction time (ms) for each combination of age and music condition</p>
                            ${this.renderCrossTabHeatmap(crossTab2, 'age_category', 'music_condition', 'mean_rt')}
                        </div>
                        
                        <!-- Interaction Analysis -->
                        <div style="background: rgba(244, 114, 182, 0.15); padding: 25px; border-radius: 12px; border-left: 4px solid #f472b6;">
                            <h4 style="margin-bottom: 10px;">üî¨ Interaction Analysis</h4>
                            ${this.renderInteractionInsight(crossTab1)}
                        </div>
                    `;
                    
                } catch (error) {
                    content.innerHTML = `<div style="text-align: center; padding: 50px;"><h3>Error: ${error.message}</h3></div>`;
                }
            },
            
            renderCrossTabHeatmap(data, rowVar, colVar, valueVar) {
                if (!data || data.length === 0) {
                    return '<p style="opacity: 0.6;">No cross-tabulation data available yet. Need data across multiple conditions and groups.</p>';
                }
                
                // Extract unique values for rows and columns
                const rows = [...new Set(data.map(d => d[rowVar]))].filter(v => v);
                const cols = [...new Set(data.map(d => d[colVar]))].filter(v => v);
                
                if (rows.length === 0 || cols.length === 0) {
                    return '<p style="opacity: 0.6;">Insufficient data for cross-tabulation.</p>';
                }
                
                // Create lookup map
                const dataMap = {};
                data.forEach(d => {
                    const key = `${d[rowVar]}|${d[colVar]}`;
                    dataMap[key] = d[valueVar];
                });
                
                // Find min/max for color scaling
                const values = data.map(d => d[valueVar]).filter(v => v != null);
                const minVal = Math.min(...values);
                const maxVal = Math.max(...values);
                const range = maxVal - minVal || 1;
                
                // Build table
                let html = '<div style="overflow-x: auto;"><table style="width: 100%; border-collapse: collapse; min-width: 500px;">';
                
                // Header row
                html += '<tr><th style="padding: 12px; text-align: left; border-bottom: 2px solid rgba(255,255,255,0.3);"></th>';
                cols.forEach(col => {
                    html += `<th style="padding: 12px; text-align: center; border-bottom: 2px solid rgba(255,255,255,0.3);">${this.formatConditionName(col)}</th>`;
                });
                html += '<th style="padding: 12px; text-align: center; border-bottom: 2px solid rgba(255,255,255,0.3); opacity: 0.7;">Row Avg</th></tr>';
                
                // Data rows
                rows.forEach(row => {
                    html += `<tr><td style="padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.1); font-weight: bold;">${this.formatRowLabel(row, rowVar)}</td>`;
                    
                    let rowSum = 0;
                    let rowCount = 0;
                    
                    cols.forEach(col => {
                        const key = `${row}|${col}`;
                        const val = dataMap[key];
                        
                        if (val != null) {
                            rowSum += val;
                            rowCount++;
                            
                            // Calculate color intensity (lower RT = better = greener)
                            const normalized = 1 - ((val - minVal) / range);
                            const r = Math.round(255 - normalized * 100);
                            const g = Math.round(150 + normalized * 105);
                            const b = Math.round(150 - normalized * 50);
                            const bgColor = `rgba(${r}, ${g}, ${b}, 0.3)`;
                            
                            html += `<td style="padding: 12px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1); background: ${bgColor}; font-weight: bold;">${Math.round(val)}</td>`;
                        } else {
                            html += `<td style="padding: 12px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1); opacity: 0.4;">--</td>`;
                        }
                    });
                    
                    // Row average
                    const rowAvg = rowCount > 0 ? rowSum / rowCount : null;
                    html += `<td style="padding: 12px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1); opacity: 0.7; font-style: italic;">${rowAvg ? Math.round(rowAvg) : '--'}</td>`;
                    html += '</tr>';
                });
                
                // Column averages row
                html += '<tr style="border-top: 2px solid rgba(255,255,255,0.3);"><td style="padding: 12px; opacity: 0.7; font-style: italic;">Col Avg</td>';
                cols.forEach(col => {
                    let colSum = 0;
                    let colCount = 0;
                    rows.forEach(row => {
                        const key = `${row}|${col}`;
                        const val = dataMap[key];
                        if (val != null) {
                            colSum += val;
                            colCount++;
                        }
                    });
                    const colAvg = colCount > 0 ? colSum / colCount : null;
                    html += `<td style="padding: 12px; text-align: center; opacity: 0.7; font-style: italic;">${colAvg ? Math.round(colAvg) : '--'}</td>`;
                });
                html += '<td></td></tr>';
                
                html += '</table></div>';
                
                // Legend
                html += `
                    <div style="display: flex; justify-content: center; align-items: center; gap: 20px; margin-top: 15px; font-size: 0.85em; opacity: 0.8;">
                        <span>Color scale:</span>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <div style="width: 20px; height: 20px; background: rgba(155, 255, 200, 0.3); border-radius: 3px;"></div>
                            <span>Faster (lower RT)</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <div style="width: 20px; height: 20px; background: rgba(255, 150, 100, 0.3); border-radius: 3px;"></div>
                            <span>Slower (higher RT)</span>
                        </div>
                    </div>
                `;
                
                return html;
            },
            
            formatRowLabel(value, varType) {
                if (varType === 'musical_background') {
                    return this.formatMusicalBackground(value);
                } else if (varType === 'age_category') {
                    return value || 'Unknown';
                }
                return value;
            },
            
            renderInteractionInsight(crossTabData) {
                if (!crossTabData || crossTabData.length < 4) {
                    return '<p style="opacity: 0.8;">Need more data across conditions and groups to analyze interactions.</p>';
                }
                
                // Group by musical background
                const byBackground = {};
                crossTabData.forEach(d => {
                    if (!byBackground[d.musical_background]) {
                        byBackground[d.musical_background] = {};
                    }
                    byBackground[d.musical_background][d.music_condition] = d.mean_rt;
                });
                
                // Calculate music benefit (silence - music average) for each group
                const benefits = [];
                Object.entries(byBackground).forEach(([bg, conditions]) => {
                    const silence = conditions.silence;
                    const musicAvg = (conditions.classical || 0 + conditions.electronic || 0) / 
                                     ((conditions.classical ? 1 : 0) + (conditions.electronic ? 1 : 0));
                    
                    if (silence && musicAvg) {
                        const benefit = silence - musicAvg;
                        benefits.push({
                            background: bg,
                            silenceRT: silence,
                            musicRT: musicAvg,
                            benefit: benefit,
                            benefitPct: (benefit / silence * 100)
                        });
                    }
                });
                
                if (benefits.length < 2) {
                    return '<p style="opacity: 0.8;">Need more data to calculate interaction effects.</p>';
                }
                
                // Find who benefits most from music
                benefits.sort((a, b) => b.benefit - a.benefit);
                const mostBenefit = benefits[0];
                const leastBenefit = benefits[benefits.length - 1];
                
                let html = `
                    <p style="margin-bottom: 15px;"><strong>Who benefits most from music?</strong></p>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                `;
                
                benefits.forEach(b => {
                    const color = b.benefit > 0 ? '#4ade80' : '#f87171';
                    const direction = b.benefit > 0 ? 'faster' : 'slower';
                    html += `
                        <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
                            <div style="font-weight: bold; margin-bottom: 8px;">${this.formatMusicalBackground(b.background)}</div>
                            <div style="font-size: 0.9em;">
                                Silence: ${Math.round(b.silenceRT)} ms<br>
                                With Music: ${Math.round(b.musicRT)} ms<br>
                                <span style="color: ${color}; font-weight: bold;">
                                    ${Math.abs(b.benefitPct).toFixed(1)}% ${direction} with music
                                </span>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                
                // Summary
                if (mostBenefit.benefit > 0 && leastBenefit.benefit <= 0) {
                    html += `
                        <div style="margin-top: 15px; padding: 12px; background: rgba(74, 222, 128, 0.2); border-radius: 8px;">
                            <strong>Key Finding:</strong> ${this.formatMusicalBackground(mostBenefit.background)} participants show the greatest benefit from music 
                            (${mostBenefit.benefitPct.toFixed(1)}% faster), while ${this.formatMusicalBackground(leastBenefit.background)} participants 
                            may perform slightly worse with music.
                        </div>
                    `;
                }
                
                return html;
            },
            
            renderMusicalBackgroundTable(data) {
                if (!data || data.length === 0) {
                    return '<p style="opacity: 0.6;">No data available.</p>';
                }
                
                let html = '<table style="width: 100%; border-collapse: collapse;">';
                html += `<tr style="border-bottom: 2px solid rgba(255,255,255,0.3);">
                    <th style="text-align: left; padding: 12px;">Musical Background</th>
                    <th style="text-align: center;">Participants</th>
                    <th style="text-align: center;">Mean RT</th>
                    <th style="text-align: center;">Accuracy</th>
                </tr>`;
                
                data.forEach(d => {
                    html += `
                        <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                            <td style="padding: 12px;">${this.formatMusicalBackground(d.musical_background)}</td>
                            <td style="text-align: center;">${d.participant_count || 0}</td>
                            <td style="text-align: center;">${d.mean_rt ? Math.round(d.mean_rt) + ' ms' : '--'}</td>
                            <td style="text-align: center;">${d.accuracy ? d.accuracy.toFixed(1) + '%' : '--'}</td>
                        </tr>
                    `;
                });
                
                html += '</table>';
                return html;
            },
            
            renderMusicianVsNonMusicianInsight(data) {
                if (!data || data.length < 2) return '';
                
                const musicians = data.filter(d => ['moderate', 'extensive', 'professional'].includes(d.musical_background));
                const nonMusicians = data.filter(d => ['none', 'casual'].includes(d.musical_background));
                
                if (musicians.length === 0 || nonMusicians.length === 0) {
                    return '<p style="margin-top: 15px; opacity: 0.7;">Need more data for comparison.</p>';
                }
                
                const musicianRT = musicians.reduce((sum, d) => sum + (d.mean_rt || 0), 0) / musicians.length;
                const nonMusicianRT = nonMusicians.reduce((sum, d) => sum + (d.mean_rt || 0), 0) / nonMusicians.length;
                
                const diff = nonMusicianRT - musicianRT;
                
                return `
                    <div style="margin-top: 15px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 8px;">
                        <strong>Musicians</strong> (moderate+ training): ${Math.round(musicianRT)} ms avg RT<br>
                        <strong>Non-Musicians</strong> (none/casual): ${Math.round(nonMusicianRT)} ms avg RT<br>
                        <strong>Difference:</strong> ${Math.round(Math.abs(diff))} ms (musicians ${diff > 0 ? 'faster' : 'slower'})
                    </div>
                `;
            },

            // ========================================
            // TEST DETAILS SECTION
            // ========================================
            
            async renderTestDetailsSection() {
                const content = document.getElementById('analyticsContent');
                
                content.innerHTML = `
                    <h2 style="margin-bottom: 25px;">üß† Test Deep Dives</h2>
                    
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                        <div style="background: rgba(255,255,255,0.05); padding: 25px; border-radius: 12px;">
                            <h3>‚ö° Simple Reaction Time</h3>
                            <p style="opacity: 0.7; margin: 10px 0;">Measures basic processing speed</p>
                            <div id="srt-metrics">Loading...</div>
                        </div>
                        
                        <div style="background: rgba(255,255,255,0.05); padding: 25px; border-radius: 12px;">
                            <h3>üö¶ Go/No-Go</h3>
                            <p style="opacity: 0.7; margin: 10px 0;">Measures response inhibition</p>
                            <div id="gonogo-metrics">Loading...</div>
                        </div>
                        
                        <div style="background: rgba(255,255,255,0.05); padding: 25px; border-radius: 12px;">
                            <h3>üåà Stroop Test</h3>
                            <p style="opacity: 0.7; margin: 10px 0;">Measures cognitive control</p>
                            <div id="stroop-metrics">Loading...</div>
                        </div>
                        
                        <div style="background: rgba(255,255,255,0.05); padding: 25px; border-radius: 12px;">
                            <h3>üî¢ Digit Span</h3>
                            <p style="opacity: 0.7; margin: 10px 0;">Measures working memory capacity</p>
                            <div id="digitspan-metrics">Loading...</div>
                        </div>
                        
                        <div style="background: rgba(255,255,255,0.05); padding: 25px; border-radius: 12px;">
                            <h3>üîÑ N-Back</h3>
                            <p style="opacity: 0.7; margin: 10px 0;">Measures working memory updating</p>
                            <div id="nback-metrics">Loading...</div>
                        </div>
                        
                        <div style="background: rgba(255,255,255,0.05); padding: 25px; border-radius: 12px;">
                            <h3>üéØ Choice Reaction</h3>
                            <p style="opacity: 0.7; margin: 10px 0;">Measures decision speed</p>
                            <div id="choice-metrics">Loading...</div>
                        </div>
                    </div>
                `;
                
                // Load test-specific metrics
                await this.loadTestMetrics();
            },
            
            async loadTestMetrics() {
                if (!this.dbReady) return;
                
                try {
                    const result = await ipcRenderer.invoke('db:getTestTypeSummary');
                    const data = result.success ? result.result : [];
                    
                    const testMapping = {
                        'simple-reaction': 'srt-metrics',
                        'go-nogo': 'gonogo-metrics',
                        'stroop': 'stroop-metrics',
                        'digit-span': 'digitspan-metrics',
                        'n-back': 'nback-metrics',
                        'choice-reaction': 'choice-metrics'
                    };
                    
                    Object.entries(testMapping).forEach(([testType, elementId]) => {
                        const element = document.getElementById(elementId);
                        if (!element) return;
                        
                        const testData = data.find(d => d.test_type === testType);
                        
                        if (testData) {
                            element.innerHTML = `
                                <div style="margin-top: 15px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                        <span>Test Runs:</span>
                                        <strong>${testData.test_count || 0}</strong>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                        <span>Mean RT:</span>
                                        <strong>${testData.mean_rt ? Math.round(testData.mean_rt) + ' ms' : '--'}</strong>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span>Accuracy:</span>
                                        <strong>${testData.accuracy ? testData.accuracy.toFixed(1) + '%' : '--'}</strong>
                                    </div>
                                </div>
                            `;
                        } else {
                            element.innerHTML = '<p style="opacity: 0.6; margin-top: 15px;">No data yet</p>';
                        }
                    });
                    
                } catch (error) {
                    console.error('Error loading test metrics:', error);
                }
            },

            // ========================================
            // PARTICIPANTS SECTION
            // ========================================
            
            async renderParticipantsSection() {
                const content = document.getElementById('analyticsContent');
                
                if (!this.dbReady) {
                    content.innerHTML = '<div style="text-align: center; padding: 50px;"><h3>Database not connected</h3></div>';
                    return;
                }
                
                try {
                    const result = await ipcRenderer.invoke('db:getAllParticipants');
                    const participants = result.success ? result.result : [];
                    
                    content.innerHTML = `
                        <h2 style="margin-bottom: 25px;">üë§ Participant Explorer</h2>
                        
                        <div style="margin-bottom: 20px;">
                            <input type="text" id="participantSearch" placeholder="Search by ID..." 
                                style="padding: 12px 20px; border-radius: 8px; border: none; background: rgba(255,255,255,0.1); color: white; width: 300px;"
                                onkeyup="app.filterParticipants()">
                        </div>
                        
                        <div style="background: rgba(255,255,255,0.05); border-radius: 12px; overflow: hidden;">
                            <table style="width: 100%; border-collapse: collapse;" id="participantTable">
                                <thead>
                                    <tr style="background: rgba(255,255,255,0.1);">
                                        <th style="text-align: left; padding: 15px;">ID</th>
                                        <th style="text-align: center; padding: 15px;">Age</th>
                                        <th style="text-align: center; padding: 15px;">Gender</th>
                                        <th style="text-align: center; padding: 15px;">Musical Background</th>
                                        <th style="text-align: center; padding: 15px;">Sessions</th>
                                        <th style="text-align: center; padding: 15px;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="participantTableBody">
                                    ${this.renderParticipantRows(participants)}
                                </tbody>
                            </table>
                        </div>
                        
                        ${participants.length === 0 ? '<p style="text-align: center; padding: 30px; opacity: 0.6;">No participants yet. Run some test sessions to see data here.</p>' : ''}
                    `;
                    
                    // Store for filtering
                    this.allParticipants = participants;
                    
                } catch (error) {
                    content.innerHTML = `<div style="text-align: center; padding: 50px;"><h3>Error: ${error.message}</h3></div>`;
                }
            },
            
            renderParticipantRows(participants) {
                if (!participants || participants.length === 0) return '';
                
                return participants.map(p => `
                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);" data-id="${p.participant_code}">
                        <td style="padding: 12px;">${p.participant_code}</td>
                        <td style="text-align: center;">${p.age_category || '--'}</td>
                        <td style="text-align: center;">${p.gender || '--'}</td>
                        <td style="text-align: center;">${this.formatMusicalBackground(p.musical_background)}</td>
                        <td style="text-align: center;">${p.session_count || 1}</td>
                        <td style="text-align: center;">
                            <button onclick="app.viewParticipantDetail(${p.id})" 
                                style="background: #60a5fa; border: none; padding: 6px 12px; border-radius: 5px; color: white; cursor: pointer;">
                                View
                            </button>
                        </td>
                    </tr>
                `).join('');
            },
            
            filterParticipants() {
                const search = document.getElementById('participantSearch').value.toLowerCase();
                const rows = document.querySelectorAll('#participantTableBody tr');
                
                rows.forEach(row => {
                    const id = row.dataset.id.toLowerCase();
                    row.style.display = id.includes(search) ? '' : 'none';
                });
            },
            
            async viewParticipantDetail(participantId) {
                alert(`Participant detail view for ID ${participantId} - Coming soon!`);
            },

            // ========================================
            // EXPORT SECTION
            // ========================================
            
            async renderExportSection() {
                const content = document.getElementById('analyticsContent');
                
                content.innerHTML = `
                    <h2 style="margin-bottom: 25px;">üì§ Export Data</h2>
                    
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                        
                        <div style="background: rgba(255,255,255,0.05); padding: 30px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 3em; margin-bottom: 15px;">üìä</div>
                            <h3 style="margin-bottom: 10px;">Raw Trial Data</h3>
                            <p style="opacity: 0.7; margin-bottom: 20px;">Export all trial-level data as CSV for analysis in SPSS, R, or Excel</p>
                            <button onclick="app.exportTrialData()" class="btn btn-primary" style="padding: 12px 30px;">
                                Export CSV
                            </button>
                        </div>
                        
                        <div style="background: rgba(255,255,255,0.05); padding: 30px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 3em; margin-bottom: 15px;">üìã</div>
                            <h3 style="margin-bottom: 10px;">Summary Statistics</h3>
                            <p style="opacity: 0.7; margin-bottom: 20px;">Export aggregated statistics by participant and condition</p>
                            <button onclick="app.exportSummaryStats()" class="btn btn-primary" style="padding: 12px 30px;">
                                Export Summary
                            </button>
                        </div>
                        
                        <div style="background: rgba(255,255,255,0.05); padding: 30px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 3em; margin-bottom: 15px;">üë•</div>
                            <h3 style="margin-bottom: 10px;">Participant Data</h3>
                            <p style="opacity: 0.7; margin-bottom: 20px;">Export demographic and background information</p>
                            <button onclick="app.exportParticipantData()" class="btn btn-primary" style="padding: 12px 30px;">
                                Export Participants
                            </button>
                        </div>
                        
                        <div style="background: rgba(255,255,255,0.05); padding: 30px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 3em; margin-bottom: 15px;">üíæ</div>
                            <h3 style="margin-bottom: 10px;">Full Database</h3>
                            <p style="opacity: 0.7; margin-bottom: 20px;">Export complete database as JSON for backup</p>
                            <button onclick="app.exportFullDatabase()" class="btn btn-secondary" style="padding: 12px 30px;">
                                Export JSON
                            </button>
                        </div>
                    </div>
                `;
            },
            
            async exportTrialData() {
                if (!this.dbReady) {
                    alert('Database not connected');
                    return;
                }
                
                try {
                    const result = await ipcRenderer.invoke('db:exportAllData');
                    if (result.success) {
                        // Convert to CSV
                        const csvData = this.convertTrialsToCSV(result.result);
                        this.downloadFile(csvData, 'trial_data.csv', 'text/csv');
                        alert('Trial data exported successfully!');
                    }
                } catch (error) {
                    alert('Export error: ' + error.message);
                }
            },
            
            convertTrialsToCSV(data) {
                if (!data.participants || data.participants.length === 0) {
                    return 'No data available';
                }
                
                // Build CSV rows
                const rows = [];
                rows.push(['participant_id', 'session_id', 'test_type', 'music_condition', 'trial_num', 'reaction_time', 'correct', 'timestamp'].join(','));
                
                data.participants.forEach(p => {
                    if (p.sessions) {
                        p.sessions.forEach(s => {
                            if (s.test_runs) {
                                s.test_runs.forEach(tr => {
                                    if (tr.trials) {
                                        tr.trials.forEach((trial, idx) => {
                                            rows.push([
                                                p.participant_code,
                                                s.session_code,
                                                tr.test_type,
                                                tr.music_condition,
                                                idx + 1,
                                                trial.reaction_time || '',
                                                trial.correct ? 1 : 0,
                                                trial.timestamp || ''
                                            ].join(','));
                                        });
                                    }
                                });
                            }
                        });
                    }
                });
                
                return rows.join('\n');
            },
            
            async exportSummaryStats() {
                if (!this.dbReady) {
                    alert('Database not connected');
                    return;
                }
                
                try {
                    const result = await ipcRenderer.invoke('db:exportAllData');
                    if (result.success) {
                        this.downloadFile(JSON.stringify(result.result, null, 2), 'summary_stats.json', 'application/json');
                        alert('Summary statistics exported!');
                    }
                } catch (error) {
                    alert('Export error: ' + error.message);
                }
            },
            
            async exportParticipantData() {
                if (!this.dbReady) {
                    alert('Database not connected');
                    return;
                }
                
                try {
                    const result = await ipcRenderer.invoke('db:getAllParticipants');
                    if (result.success) {
                        const csv = this.convertParticipantsToCSV(result.result);
                        this.downloadFile(csv, 'participants.csv', 'text/csv');
                        alert('Participant data exported!');
                    }
                } catch (error) {
                    alert('Export error: ' + error.message);
                }
            },
            
            convertParticipantsToCSV(participants) {
                if (!participants || participants.length === 0) return 'No data';
                
                const headers = ['participant_code', 'age_category', 'gender', 'dominant_hand', 'musical_background', 'current_music_engagement', 'hearing_impairment', 'sleep_hours', 'caffeine_source', 'created_at'];
                const rows = [headers.join(',')];
                
                participants.forEach(p => {
                    rows.push(headers.map(h => p[h] || '').join(','));
                });
                
                return rows.join('\n');
            },
            
            async exportFullDatabase() {
                if (!this.dbReady) {
                    alert('Database not connected');
                    return;
                }
                
                try {
                    const result = await ipcRenderer.invoke('db:exportAllData');
                    if (result.success) {
                        this.downloadFile(JSON.stringify(result.result, null, 2), 'full_database_export.json', 'application/json');
                        alert('Full database exported!');
                    }
                } catch (error) {
                    alert('Export error: ' + error.message);
                }
            },
            
            downloadFile(content, filename, type) {
                const blob = new Blob([content], { type: type });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                URL.revokeObjectURL(url);
            },

            setupEventListeners() {
                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        this.handleEscape();
                    }
                });
                
                // Hardware button events
                ipcRenderer.on('button-press', (event, data) => {
                    console.log('Button pressed:', data);
                    // Handle button press in tests
                });
                
                ipcRenderer.on('button-release', (event, data) => {
                    console.log('Button released:', data);
                });
            },

            async showScreen(screenId) {
                document.querySelectorAll('.screen').forEach(screen => {
                    screen.classList.add('hidden');
                });
                
                const targetScreen = document.getElementById(screenId);
                if (targetScreen) {
                    targetScreen.classList.remove('hidden');
                    targetScreen.classList.add('fade-in');
                    this.currentScreen = screenId;
                    
                    // Load next participant ID when showing participant screen
                    if (screenId === 'participantScreen') {
                        await this.loadNextParticipantId();
                    }
                    
                    // Initialize analytics when showing analytics screen
                    if (screenId === 'analyticsHome') {
                        await this.showAnalyticsSection('overview');
                    }
                    
                    // Refresh home stats when returning to welcome
                    if (screenId === 'welcomeScreen') {
                        await this.loadHomeStats();
                    }
                }
            },

            async loadNextParticipantId() {
                const displayElement = document.getElementById('displayParticipantId');
                
                if (this.dbReady) {
                    try {
                        const result = await ipcRenderer.invoke('db:getNextParticipantCode');
                        if (result.success) {
                            this.currentParticipantId = result.result;
                            if (displayElement) {
                                displayElement.textContent = result.result;
                            }
                            return;
                        }
                    } catch (error) {
                        console.error('Error getting participant code:', error);
                    }
                }
                
                // Fallback to timestamp-based ID
                this.currentParticipantId = 'P' + Date.now();
                if (displayElement) {
                    displayElement.textContent = this.currentParticipantId;
                }
            },

            async handleParticipantSubmit() {
                // Validate required fields
                const ageCategory = document.getElementById('ageCategory').value;
                const dominantHand = document.getElementById('dominantHand').value;
                const musicalBackground = document.getElementById('musicalBackground').value;
                const currentMusicEngagement = document.getElementById('currentMusicEngagement').value;
                const hearingImpairment = document.getElementById('hearingImpairment').value;
                
                if (!ageCategory || !dominantHand || !musicalBackground || !currentMusicEngagement || !hearingImpairment) {
                    alert('Please fill in all required fields marked with *');
                    return;
                }
                
                // Gather participant data
                const participantData = {
                    participant_code: this.currentParticipantId,
                    age_category: ageCategory,
                    gender: document.getElementById('gender').value || null,
                    dominant_hand: dominantHand,
                    musical_background: musicalBackground,
                    current_music_engagement: currentMusicEngagement,
                    hearing_impairment: hearingImpairment,
                    medications: document.getElementById('medications').value || null,
                    caffeine_source: document.getElementById('caffeineSource').value || null,
                    caffeine_amount: document.getElementById('caffeineAmount').value || null,
                    sleep_hours: parseFloat(document.getElementById('sleepHours').value) || null,
                    notes: document.getElementById('notes').value || null
                };
                
                // Save to database
                if (this.dbReady) {
                    try {
                        // Create participant
                        const participantResult = await ipcRenderer.invoke('db:createParticipant', participantData);
                        if (!participantResult.success) {
                            throw new Error(participantResult.error);
                        }
                        
                        this.currentParticipantDbId = participantResult.result.id;
                        this.currentParticipantId = participantResult.result.participant_code;
                        
                        // Create session
                        const sessionResult = await ipcRenderer.invoke('db:createSession', 
                            this.currentParticipantDbId,
                            { platform: process.platform, timestamp: Date.now() }
                        );
                        
                        if (!sessionResult.success) {
                            throw new Error(sessionResult.error);
                        }
                        
                        this.currentSessionDbId = sessionResult.result.id;
                        
                        this.currentSession = {
                            id: sessionResult.result.session_code,
                            dbId: sessionResult.result.id,
                            participant: {
                                id: this.currentParticipantId,
                                dbId: this.currentParticipantDbId,
                                ...participantData
                            },
                            startTime: new Date().toISOString(),
                            tests: [],
                            results: {}
                        };
                        
                        console.log('‚úÖ Participant and session created:', this.currentParticipantId);
                        
                    } catch (error) {
                        console.error('Database error:', error);
                        alert('Error saving to database. Data will be stored locally.');
                        this.createLocalSession(participantData);
                    }
                } else {
                    this.createLocalSession(participantData);
                }
                
                this.displaySessionInfo();
                this.showScreen('testSelectionScreen');
            },

            createLocalSession(participantData) {
                this.currentSession = {
                    id: 'SESSION_' + Date.now(),
                    participant: {
                        id: this.currentParticipantId,
                        ...participantData
                    },
                    startTime: new Date().toISOString(),
                    tests: [],
                    results: {}
                };
            },

            displaySessionInfo() {
                const info = document.getElementById('sessionInfo');
                if (info && this.currentSession) {
                    const p = this.currentSession.participant;
                    const musicLevel = this.getMusicLevelDisplay(p.musical_background);
                    info.innerHTML = `
                        <strong>Participant ID:</strong> ${p.id} | 
                        <strong>Age:</strong> ${p.age_category} | 
                        <strong>Hand:</strong> ${p.dominant_hand} | 
                        <strong>Musical Background:</strong> ${musicLevel}
                    `;
                }
            },

            getMusicLevelDisplay(level) {
                const levels = {
                    'none': 'No training',
                    'casual': 'Casual',
                    'some-lessons': 'Some lessons',
                    'moderate': 'Moderate',
                    'extensive': 'Extensive',
                    'professional': 'Professional'
                };
                return levels[level] || level || 'Not specified';
            },

            toggleTest(card) {
                card.classList.toggle('selected');
            },

            toggleSuite(card) {
                const suiteId = card.dataset.suite;
                const isSelected = card.classList.contains('selected');
                
                if (isSelected) {
                    // Deselecting - but keep at least one selected
                    const selectedCount = document.querySelectorAll('.suite-card.selected').length;
                    if (selectedCount <= 1) {
                        return; // Must have at least one suite selected
                    }
                    card.classList.remove('selected');
                    card.style.background = 'rgba(255,255,255,0.1)';
                    card.style.borderColor = 'transparent';
                    this.selectedSuites = this.selectedSuites.filter(s => s !== suiteId);
                } else {
                    // Selecting
                    card.classList.add('selected');
                    card.style.background = 'rgba(74, 222, 128, 0.2)';
                    card.style.borderColor = '#4ade80';
                    if (!this.selectedSuites.includes(suiteId)) {
                        this.selectedSuites.push(suiteId);
                    }
                }
                
                this.updateTimeEstimate();
            },

            updateTimeEstimate() {
                let totalTime = 0;
                let testCount = 0;
                
                this.selectedSuites.forEach(suiteId => {
                    const suite = this.testSuites[suiteId];
                    if (suite) {
                        totalTime += suite.duration;
                        testCount += suite.tests.length;
                    }
                });
                
                document.getElementById('estimatedTime').textContent = `~${totalTime} minutes`;
                document.getElementById('timeBreakdown').textContent = 
                    `${testCount} tests √ó 3 music conditions + transitions`;
            },

            selectStandardBattery() {
                document.querySelectorAll('.suite-card').forEach(card => {
                    card.classList.add('selected');
                    card.style.background = 'rgba(74, 222, 128, 0.2)';
                    card.style.borderColor = '#4ade80';
                    const suiteId = card.dataset.suite;
                    if (!this.selectedSuites.includes(suiteId)) {
                        this.selectedSuites.push(suiteId);
                    }
                });
                this.updateTimeEstimate();
            },

            async startTestBattery() {
                if (this.selectedSuites.length === 0) {
                    alert('Please select at least one test suite');
                    return;
                }
                
                // Build test queue from selected suites
                this.selectedTests = [];
                this.selectedSuites.forEach(suiteId => {
                    const suite = this.testSuites[suiteId];
                    if (suite) {
                        this.selectedTests.push(...suite.tests);
                    }
                });
                
                // Store in session
                this.currentSession.selectedSuites = [...this.selectedSuites];
                this.currentSession.selectedTests = [...this.selectedTests];
                this.currentSession.musicConditions = [...this.musicConditions];
                
                // Create full test queue (tests √ó conditions)
                this.testQueue = [];
                this.musicConditions.forEach(condition => {
                    this.selectedTests.forEach(test => {
                        this.testQueue.push({
                            test: test,
                            condition: condition
                        });
                    });
                });
                
                // Counterbalance: randomize order within each condition block
                // (keeps conditions grouped but randomizes test order)
                
                const totalTests = this.testQueue.length;
                const totalTime = this.selectedSuites.reduce((sum, id) => sum + (this.testSuites[id]?.duration || 0), 0);
                
                alert(`Starting session:\n\n` +
                      `‚Ä¢ ${this.selectedSuites.length} suite(s) selected\n` +
                      `‚Ä¢ ${this.selectedTests.length} tests per condition\n` +
                      `‚Ä¢ 3 music conditions\n` +
                      `‚Ä¢ ${totalTests} total test runs\n` +
                      `‚Ä¢ Estimated time: ~${totalTime} minutes`);
                
                this.testIndex = 0;
                this.testIndex = 0;
                this.runNextTest();
            },

            async runNextTest() {
                if (this.testIndex >= this.testQueue.length) {
                    await this.finishSession();
                    return;
                }
                
                const currentItem = this.testQueue[this.testIndex];
                this.showScreen('testScreen');
                
                // Test name mapping
                const testNames = {
                    'simple-reaction': 'Simple Reaction Time',
                    'go-nogo': 'Go/No-Go Task',
                    'stroop': 'Stroop Test',
                    'choice-reaction': 'Choice Reaction Time',
                    'digit-span': 'Digit Span',
                    'n-back': 'N-Back (2-Back)'
                };
                
                const conditionNames = {
                    'silence': 'üîá Silence',
                    'classical': 'üéª Classical',
                    'electronic': 'üéß Electronic'
                };
                
                const testName = testNames[currentItem.test] || currentItem.test;
                const conditionName = conditionNames[currentItem.condition] || currentItem.condition;
                
                document.getElementById('testTitle').textContent = testName;
                document.getElementById('testInstructions').innerHTML = `
                    <p><strong>Music Condition:</strong> ${conditionName}</p>
                    <p><strong>Progress:</strong> Test ${this.testIndex + 1} of ${this.testQueue.length}</p>
                `;
                
                // Update progress bar
                const progress = ((this.testIndex + 1) / this.testQueue.length) * 100;
                document.getElementById('progressFill').style.width = `${progress}%`;
                document.getElementById('progressFill').textContent = `${Math.round(progress)}%`;
                
                console.log(`Running: ${currentItem.test} with ${currentItem.condition}`);
                
                // Start music for this condition
                await this.startMusicCondition(currentItem.condition);
                
                // Run the actual test
                await this.executeTest(currentItem.test, currentItem.condition);
            },

            // ========================================
            // MUSIC CONDITION HANDLING
            // ========================================
            
            currentAudio: null,
            
            async startMusicCondition(condition) {
                // Stop any existing audio
                this.stopMusic();
                
                if (condition === 'silence') {
                    console.log('Silence condition - no music');
                    return;
                }
                
                const audioFiles = {
                    'classical': 'audio/classical_60bpm.mp3',
                    'electronic': 'audio/electronic_140bpm.mp3'
                };
                
                const audioFile = audioFiles[condition];
                if (audioFile) {
                    try {
                        this.currentAudio = new Audio(audioFile);
                        this.currentAudio.loop = true;
                        this.currentAudio.volume = 0.5;
                        await this.currentAudio.play();
                        console.log(`Playing: ${condition}`);
                    } catch (error) {
                        console.warn('Audio playback failed:', error);
                    }
                }
            },
            
            stopMusic() {
                if (this.currentAudio) {
                    this.currentAudio.pause();
                    this.currentAudio.currentTime = 0;
                    this.currentAudio = null;
                }
            },

            // ========================================
            // TEST EXECUTION
            // ========================================
            
            currentTestData: [],
            testStartTime: null,
            testIsRunning: false,
            
            async executeTest(testType, condition) {
                this.currentTestData = [];
                this.testStartTime = performance.now();
                this.testIsRunning = true;
                
                const canvas = this.canvas;
                const ctx = this.ctx;
                
                // Clear canvas
                ctx.fillStyle = '#1a1a2e';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Test durations in ms
                const durations = {
                    'simple-reaction': 60000,    // 1 min
                    'go-nogo': 90000,            // 1.5 min
                    'stroop': 90000,             // 1.5 min
                    'choice-reaction': 90000,   // 1.5 min
                    'digit-span': 120000,        // 2 min
                    'n-back': 120000             // 2 min
                };
                
                const duration = durations[testType] || 60000;
                
                // Run appropriate test
                switch (testType) {
                    case 'simple-reaction':
                        await this.runSimpleReactionTest(canvas, ctx, duration);
                        break;
                    case 'go-nogo':
                        await this.runGoNoGoTest(canvas, ctx, duration);
                        break;
                    case 'stroop':
                        await this.runStroopTest(canvas, ctx, duration);
                        break;
                    case 'choice-reaction':
                        await this.runChoiceReactionTest(canvas, ctx, duration);
                        break;
                    case 'digit-span':
                        await this.runDigitSpanTest(canvas, ctx, duration);
                        break;
                    case 'n-back':
                        await this.runNBackTest(canvas, ctx, duration);
                        break;
                    default:
                        console.error('Unknown test type:', testType);
                        await this.delay(2000);
                }
                
                // Test complete - save results
                await this.saveTestResults(testType, condition);
                
                // Stop music
                this.stopMusic();
                
                // Show brief completion message
                ctx.fillStyle = '#1a1a2e';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#4ade80';
                ctx.font = 'bold 36px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('Test Complete!', canvas.width/2, canvas.height/2);
                
                await this.delay(1500);
                
                // Move to next test
                this.testIndex++;
                this.runNextTest();
            },
            
            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            },

            // ========================================
            // SIMPLE REACTION TIME TEST
            // ========================================
            
            async runSimpleReactionTest(canvas, ctx, duration) {
                return new Promise(async (resolve) => {
                    const trials = [];
                    let trialNum = 0;
                    const startTime = performance.now();
                    
                    const runTrial = async () => {
                        if (performance.now() - startTime >= duration || !this.testIsRunning) {
                            this.currentTestData = trials;
                            resolve();
                            return;
                        }
                        
                        trialNum++;
                        
                        // Show fixation
                        ctx.fillStyle = '#1a1a2e';
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                        ctx.fillStyle = '#ffffff';
                        ctx.font = '48px Arial';
                        ctx.textAlign = 'center';
                        ctx.fillText('+', canvas.width/2, canvas.height/2);
                        ctx.font = '16px Arial';
                        ctx.fillText(`Trial ${trialNum} | Press SPACE when you see the circle`, canvas.width/2, canvas.height - 50);
                        
                        // Random wait (2-4 seconds)
                        const waitTime = 2000 + Math.random() * 2000;
                        await this.delay(waitTime);
                        
                        if (!this.testIsRunning) { resolve(); return; }
                        
                        // Show stimulus
                        const stimulusTime = performance.now();
                        ctx.fillStyle = '#1a1a2e';
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                        ctx.beginPath();
                        ctx.arc(canvas.width/2, canvas.height/2, 80, 0, Math.PI * 2);
                        ctx.fillStyle = '#ff6b6b';
                        ctx.fill();
                        ctx.font = '16px Arial';
                        ctx.fillStyle = '#ffffff';
                        ctx.fillText('PRESS SPACE NOW!', canvas.width/2, canvas.height - 50);
                        
                        // Wait for response
                        const response = await this.waitForKey(' ', 2000);
                        const rt = response ? response.rt : null;
                        
                        trials.push({
                            trial: trialNum,
                            reactionTime: rt,
                            correct: rt !== null,
                            timestamp: stimulusTime
                        });
                        
                        // Brief feedback
                        ctx.fillStyle = '#1a1a2e';
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                        ctx.font = '24px Arial';
                        ctx.fillStyle = rt ? '#4ade80' : '#ff6b6b';
                        ctx.fillText(rt ? `${Math.round(rt)} ms` : 'Too slow!', canvas.width/2, canvas.height/2);
                        
                        await this.delay(500);
                        
                        // Next trial
                        runTrial();
                    };
                    
                    runTrial();
                });
            },

            // ========================================
            // GO/NO-GO TEST
            // ========================================
            
            async runGoNoGoTest(canvas, ctx, duration) {
                return new Promise(async (resolve) => {
                    const trials = [];
                    let trialNum = 0;
                    const startTime = performance.now();
                    
                    const runTrial = async () => {
                        if (performance.now() - startTime >= duration || !this.testIsRunning) {
                            this.currentTestData = trials;
                            resolve();
                            return;
                        }
                        
                        trialNum++;
                        const isGo = Math.random() < 0.75; // 75% go trials
                        
                        // Show fixation
                        ctx.fillStyle = '#1a1a2e';
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                        ctx.fillStyle = '#ffffff';
                        ctx.font = '48px Arial';
                        ctx.textAlign = 'center';
                        ctx.fillText('+', canvas.width/2, canvas.height/2);
                        ctx.font = '16px Arial';
                        ctx.fillText('Press SPACE for GREEN | Do NOT press for RED', canvas.width/2, canvas.height - 50);
                        
                        await this.delay(1000 + Math.random() * 1000);
                        
                        if (!this.testIsRunning) { resolve(); return; }
                        
                        // Show stimulus
                        const stimulusTime = performance.now();
                        ctx.fillStyle = '#1a1a2e';
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                        ctx.beginPath();
                        ctx.arc(canvas.width/2, canvas.height/2, 80, 0, Math.PI * 2);
                        ctx.fillStyle = isGo ? '#4ade80' : '#ff6b6b';
                        ctx.fill();
                        
                        // Wait for response (shorter window)
                        const response = await this.waitForKey(' ', 1000);
                        const pressed = response !== null;
                        const rt = response ? response.rt : null;
                        
                        // Determine correctness
                        const correct = (isGo && pressed) || (!isGo && !pressed);
                        
                        trials.push({
                            trial: trialNum,
                            type: isGo ? 'go' : 'nogo',
                            responded: pressed,
                            reactionTime: rt,
                            correct: correct,
                            timestamp: stimulusTime
                        });
                        
                        // Brief feedback
                        ctx.fillStyle = '#1a1a2e';
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                        ctx.font = '24px Arial';
                        ctx.fillStyle = correct ? '#4ade80' : '#ff6b6b';
                        ctx.fillText(correct ? '‚úì' : '‚úó', canvas.width/2, canvas.height/2);
                        
                        await this.delay(300);
                        
                        runTrial();
                    };
                    
                    runTrial();
                });
            },

            // ========================================
            // STROOP TEST
            // ========================================
            
            async runStroopTest(canvas, ctx, duration) {
                return new Promise(async (resolve) => {
                    const trials = [];
                    let trialNum = 0;
                    const startTime = performance.now();
                    
                    const colors = [
                        { name: 'RED', hex: '#ff6b6b', key: 'a' },
                        { name: 'GREEN', hex: '#4ade80', key: 's' },
                        { name: 'BLUE', hex: '#60a5fa', key: 'd' },
                        { name: 'YELLOW', hex: '#fbbf24', key: 'f' }
                    ];
                    
                    const runTrial = async () => {
                        if (performance.now() - startTime >= duration || !this.testIsRunning) {
                            this.currentTestData = trials;
                            resolve();
                            return;
                        }
                        
                        trialNum++;
                        
                        // Pick word and ink color (50% congruent, 50% incongruent)
                        const isCongruent = Math.random() < 0.5;
                        const wordColor = colors[Math.floor(Math.random() * colors.length)];
                        const inkColor = isCongruent ? wordColor : colors.filter(c => c !== wordColor)[Math.floor(Math.random() * 3)];
                        
                        // Show fixation
                        ctx.fillStyle = '#1a1a2e';
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                        ctx.fillStyle = '#ffffff';
                        ctx.font = '48px Arial';
                        ctx.textAlign = 'center';
                        ctx.fillText('+', canvas.width/2, canvas.height/2);
                        ctx.font = '14px Arial';
                        ctx.fillText('Press: A=Red  S=Green  D=Blue  F=Yellow  (name the INK color)', canvas.width/2, canvas.height - 50);
                        
                        await this.delay(500 + Math.random() * 500);
                        
                        if (!this.testIsRunning) { resolve(); return; }
                        
                        // Show word in colored ink
                        const stimulusTime = performance.now();
                        ctx.fillStyle = '#1a1a2e';
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                        ctx.fillStyle = inkColor.hex;
                        ctx.font = 'bold 72px Arial';
                        ctx.fillText(wordColor.name, canvas.width/2, canvas.height/2);
                        ctx.fillStyle = '#ffffff';
                        ctx.font = '14px Arial';
                        ctx.fillText('A=Red  S=Green  D=Blue  F=Yellow', canvas.width/2, canvas.height - 50);
                        
                        // Wait for response
                        const response = await this.waitForKeys(['a', 's', 'd', 'f'], 2000);
                        const rt = response ? response.rt : null;
                        const correct = response && response.key === inkColor.key;
                        
                        trials.push({
                            trial: trialNum,
                            word: wordColor.name,
                            inkColor: inkColor.name,
                            congruent: isCongruent,
                            response: response ? response.key : null,
                            reactionTime: rt,
                            correct: correct,
                            timestamp: stimulusTime
                        });
                        
                        // Brief feedback
                        ctx.fillStyle = '#1a1a2e';
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                        ctx.font = '36px Arial';
                        ctx.fillStyle = correct ? '#4ade80' : '#ff6b6b';
                        ctx.fillText(correct ? '‚úì' : '‚úó', canvas.width/2, canvas.height/2);
                        
                        await this.delay(300);
                        
                        runTrial();
                    };
                    
                    runTrial();
                });
            },

            // ========================================
            // CHOICE REACTION TIME TEST
            // ========================================
            
            async runChoiceReactionTest(canvas, ctx, duration) {
                return new Promise(async (resolve) => {
                    const trials = [];
                    let trialNum = 0;
                    const startTime = performance.now();
                    
                    const buttons = [
                        { position: 0, color: '#4ade80', key: 'a', name: 'Green (A)' },
                        { position: 1, color: '#ffffff', key: 's', name: 'White (S)' },
                        { position: 2, color: '#ff6b6b', key: 'd', name: 'Red (D)' },
                        { position: 3, color: '#60a5fa', key: 'f', name: 'Blue (F)' }
                    ];
                    
                    const runTrial = async () => {
                        if (performance.now() - startTime >= duration || !this.testIsRunning) {
                            this.currentTestData = trials;
                            resolve();
                            return;
                        }
                        
                        trialNum++;
                        const target = buttons[Math.floor(Math.random() * buttons.length)];
                        
                        // Show fixation with button legend
                        ctx.fillStyle = '#1a1a2e';
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                        ctx.fillStyle = '#ffffff';
                        ctx.font = '48px Arial';
                        ctx.textAlign = 'center';
                        ctx.fillText('+', canvas.width/2, canvas.height/2);
                        ctx.font = '14px Arial';
                        ctx.fillText('Press the matching key: A=Green  S=White  D=Red  F=Blue', canvas.width/2, canvas.height - 50);
                        
                        await this.delay(1000 + Math.random() * 1000);
                        
                        if (!this.testIsRunning) { resolve(); return; }
                        
                        // Show colored circle
                        const stimulusTime = performance.now();
                        ctx.fillStyle = '#1a1a2e';
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                        ctx.beginPath();
                        ctx.arc(canvas.width/2, canvas.height/2, 80, 0, Math.PI * 2);
                        ctx.fillStyle = target.color;
                        ctx.fill();
                        if (target.color === '#ffffff') {
                            ctx.strokeStyle = '#666';
                            ctx.lineWidth = 3;
                            ctx.stroke();
                        }
                        ctx.fillStyle = '#ffffff';
                        ctx.font = '14px Arial';
                        ctx.fillText('A=Green  S=White  D=Red  F=Blue', canvas.width/2, canvas.height - 50);
                        
                        // Wait for response
                        const response = await this.waitForKeys(['a', 's', 'd', 'f'], 2000);
                        const rt = response ? response.rt : null;
                        const correct = response && response.key === target.key;
                        
                        trials.push({
                            trial: trialNum,
                            target: target.name,
                            targetKey: target.key,
                            response: response ? response.key : null,
                            reactionTime: rt,
                            correct: correct,
                            timestamp: stimulusTime
                        });
                        
                        // Brief feedback
                        ctx.fillStyle = '#1a1a2e';
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                        ctx.font = '24px Arial';
                        ctx.fillStyle = correct ? '#4ade80' : '#ff6b6b';
                        ctx.fillText(correct ? `‚úì ${Math.round(rt)} ms` : '‚úó Wrong key', canvas.width/2, canvas.height/2);
                        
                        await this.delay(400);
                        
                        runTrial();
                    };
                    
                    runTrial();
                });
            },

            // ========================================
            // DIGIT SPAN TEST
            // ========================================
            
            async runDigitSpanTest(canvas, ctx, duration) {
                return new Promise(async (resolve) => {
                    const trials = [];
                    let spanLength = 3; // Start with 3 digits
                    let consecutiveCorrect = 0;
                    let consecutiveWrong = 0;
                    const startTime = performance.now();
                    
                    const runTrial = async () => {
                        if (performance.now() - startTime >= duration || !this.testIsRunning || spanLength < 2) {
                            this.currentTestData = trials;
                            resolve();
                            return;
                        }
                        
                        // Generate random digit sequence
                        const sequence = [];
                        for (let i = 0; i < spanLength; i++) {
                            sequence.push(Math.floor(Math.random() * 10));
                        }
                        
                        // Show "Get Ready"
                        ctx.fillStyle = '#1a1a2e';
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                        ctx.fillStyle = '#ffffff';
                        ctx.font = '24px Arial';
                        ctx.textAlign = 'center';
                        ctx.fillText(`Remember ${spanLength} digits...`, canvas.width/2, canvas.height/2);
                        
                        await this.delay(1500);
                        
                        // Show each digit
                        for (let i = 0; i < sequence.length; i++) {
                            if (!this.testIsRunning) { resolve(); return; }
                            
                            ctx.fillStyle = '#1a1a2e';
                            ctx.fillRect(0, 0, canvas.width, canvas.height);
                            ctx.fillStyle = '#60a5fa';
                            ctx.font = 'bold 120px Arial';
                            ctx.fillText(sequence[i].toString(), canvas.width/2, canvas.height/2 + 40);
                            
                            await this.delay(1000);
                        }
                        
                        // Prompt for recall
                        ctx.fillStyle = '#1a1a2e';
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                        ctx.fillStyle = '#ffffff';
                        ctx.font = '24px Arial';
                        ctx.fillText('Type the digits you saw, then press ENTER', canvas.width/2, canvas.height/2 - 50);
                        
                        let userInput = '';
                        ctx.font = 'bold 48px Arial';
                        ctx.fillStyle = '#4ade80';
                        ctx.fillText(userInput + '_', canvas.width/2, canvas.height/2 + 30);
                        
                        // Collect digit input
                        const response = await this.collectDigitInput(canvas, ctx, spanLength);
                        
                        const correct = response === sequence.join('');
                        
                        trials.push({
                            spanLength: spanLength,
                            sequence: sequence.join(''),
                            response: response,
                            correct: correct
                        });
                        
                        // Feedback
                        ctx.fillStyle = '#1a1a2e';
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                        ctx.font = '36px Arial';
                        ctx.fillStyle = correct ? '#4ade80' : '#ff6b6b';
                        ctx.fillText(correct ? '‚úì Correct!' : `‚úó Was: ${sequence.join('')}`, canvas.width/2, canvas.height/2);
                        
                        await this.delay(1500);
                        
                        // Adjust span length
                        if (correct) {
                            consecutiveCorrect++;
                            consecutiveWrong = 0;
                            if (consecutiveCorrect >= 2) {
                                spanLength++;
                                consecutiveCorrect = 0;
                            }
                        } else {
                            consecutiveWrong++;
                            consecutiveCorrect = 0;
                            if (consecutiveWrong >= 2) {
                                spanLength--;
                            }
                        }
                        
                        runTrial();
                    };
                    
                    runTrial();
                });
            },
            
            async collectDigitInput(canvas, ctx, maxLength) {
                return new Promise((resolve) => {
                    let input = '';
                    
                    const updateDisplay = () => {
                        ctx.fillStyle = '#1a1a2e';
                        ctx.fillRect(0, canvas.height/2 - 20, canvas.width, 80);
                        ctx.font = 'bold 48px Arial';
                        ctx.fillStyle = '#4ade80';
                        ctx.textAlign = 'center';
                        ctx.fillText(input + (input.length < maxLength ? '_' : ''), canvas.width/2, canvas.height/2 + 30);
                    };
                    
                    const handler = (e) => {
                        if (e.key >= '0' && e.key <= '9' && input.length < maxLength) {
                            input += e.key;
                            updateDisplay();
                        } else if (e.key === 'Backspace') {
                            input = input.slice(0, -1);
                            updateDisplay();
                        } else if (e.key === 'Enter' && input.length > 0) {
                            document.removeEventListener('keydown', handler);
                            resolve(input);
                        }
                    };
                    
                    document.addEventListener('keydown', handler);
                    
                    // Timeout after 15 seconds
                    setTimeout(() => {
                        document.removeEventListener('keydown', handler);
                        resolve(input);
                    }, 15000);
                });
            },

            // ========================================
            // N-BACK TEST
            // ========================================
            
            async runNBackTest(canvas, ctx, duration) {
                return new Promise(async (resolve) => {
                    const trials = [];
                    const n = 2; // 2-back
                    const letters = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'];
                    const history = [];
                    let trialNum = 0;
                    const startTime = performance.now();
                    
                    // Instructions
                    ctx.fillStyle = '#1a1a2e';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.fillStyle = '#ffffff';
                    ctx.font = '24px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('2-BACK TASK', canvas.width/2, canvas.height/2 - 60);
                    ctx.font = '18px Arial';
                    ctx.fillText('Press SPACE if the letter matches the one from 2 letters ago', canvas.width/2, canvas.height/2);
                    ctx.fillText('Starting in 3 seconds...', canvas.width/2, canvas.height/2 + 40);
                    
                    await this.delay(3000);
                    
                    const runTrial = async () => {
                        if (performance.now() - startTime >= duration || !this.testIsRunning) {
                            this.currentTestData = trials;
                            resolve();
                            return;
                        }
                        
                        trialNum++;
                        
                        // Decide if this should be a target (match n-back) - ~30% of trials
                        let currentLetter;
                        const isTarget = history.length >= n && Math.random() < 0.3;
                        
                        if (isTarget) {
                            currentLetter = history[history.length - n];
                        } else {
                            // Pick a letter that doesn't match n-back
                            do {
                                currentLetter = letters[Math.floor(Math.random() * letters.length)];
                            } while (history.length >= n && currentLetter === history[history.length - n]);
                        }
                        
                        // Show letter
                        const stimulusTime = performance.now();
                        ctx.fillStyle = '#1a1a2e';
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                        ctx.fillStyle = '#60a5fa';
                        ctx.font = 'bold 120px Arial';
                        ctx.textAlign = 'center';
                        ctx.fillText(currentLetter, canvas.width/2, canvas.height/2 + 40);
                        ctx.fillStyle = '#666';
                        ctx.font = '14px Arial';
                        ctx.fillText('Press SPACE if this matches 2 letters ago', canvas.width/2, canvas.height - 50);
                        
                        // Wait for response
                        const response = await this.waitForKey(' ', 2000);
                        const pressed = response !== null;
                        
                        // Only count as correct/incorrect if we've seen enough letters
                        const correct = history.length >= n ? 
                            (isTarget && pressed) || (!isTarget && !pressed) : 
                            !pressed;
                        
                        trials.push({
                            trial: trialNum,
                            letter: currentLetter,
                            isTarget: isTarget,
                            responded: pressed,
                            reactionTime: response ? response.rt : null,
                            correct: correct,
                            timestamp: stimulusTime
                        });
                        
                        history.push(currentLetter);
                        
                        // Brief blank
                        ctx.fillStyle = '#1a1a2e';
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                        
                        await this.delay(500);
                        
                        runTrial();
                    };
                    
                    runTrial();
                });
            },

            // ========================================
            // INPUT HELPERS
            // ========================================
            
            waitForKey(key, timeout) {
                return new Promise((resolve) => {
                    const startTime = performance.now();
                    let resolved = false;
                    
                    const handler = (e) => {
                        if (e.key === key && !resolved) {
                            resolved = true;
                            document.removeEventListener('keydown', handler);
                            resolve({ key: e.key, rt: performance.now() - startTime });
                        }
                    };
                    
                    document.addEventListener('keydown', handler);
                    
                    setTimeout(() => {
                        if (!resolved) {
                            resolved = true;
                            document.removeEventListener('keydown', handler);
                            resolve(null);
                        }
                    }, timeout);
                });
            },
            
            waitForKeys(keys, timeout) {
                return new Promise((resolve) => {
                    const startTime = performance.now();
                    let resolved = false;
                    
                    const handler = (e) => {
                        if (keys.includes(e.key.toLowerCase()) && !resolved) {
                            resolved = true;
                            document.removeEventListener('keydown', handler);
                            resolve({ key: e.key.toLowerCase(), rt: performance.now() - startTime });
                        }
                    };
                    
                    document.addEventListener('keydown', handler);
                    
                    setTimeout(() => {
                        if (!resolved) {
                            resolved = true;
                            document.removeEventListener('keydown', handler);
                            resolve(null);
                        }
                    }, timeout);
                });
            },

            // ========================================
            // SAVE TEST RESULTS
            // ========================================
            
            async saveTestResults(testType, condition) {
                const results = {
                    testType: testType,
                    condition: condition,
                    trials: this.currentTestData,
                    timestamp: new Date().toISOString(),
                    summary: this.calculateTestSummary(testType, this.currentTestData)
                };
                
                // Add to session
                if (!this.currentSession.tests) {
                    this.currentSession.tests = [];
                }
                this.currentSession.tests.push(results);
                
                // Save to database if available
                if (this.dbReady && this.currentSessionDbId) {
                    try {
                        const testRun = await ipcRenderer.invoke('db:createTestRun',
                            this.currentSessionDbId,
                            testType,
                            condition,
                            { duration: this.currentTestData.length }
                        );
                        
                        if (testRun.success && this.currentTestData.length > 0) {
                            await ipcRenderer.invoke('db:recordTrials', testRun.result.id, this.currentTestData);
                            await ipcRenderer.invoke('db:createTestSummary', testRun.result.id);
                        }
                    } catch (error) {
                        console.error('Error saving to database:', error);
                    }
                }
                
                console.log(`Saved ${this.currentTestData.length} trials for ${testType} (${condition})`);
            },
            
            calculateTestSummary(testType, trials) {
                if (!trials || trials.length === 0) {
                    return { error: 'No trial data' };
                }
                
                const correctTrials = trials.filter(t => t.correct);
                const rts = trials.filter(t => t.reactionTime).map(t => t.reactionTime);
                
                const meanRT = rts.length > 0 ? rts.reduce((a, b) => a + b, 0) / rts.length : null;
                const accuracy = (correctTrials.length / trials.length) * 100;
                
                return {
                    totalTrials: trials.length,
                    correctTrials: correctTrials.length,
                    accuracy: accuracy.toFixed(1),
                    meanRT: meanRT ? meanRT.toFixed(0) : null,
                    medianRT: rts.length > 0 ? this.median(rts).toFixed(0) : null
                };
            },
            
            median(arr) {
                const sorted = [...arr].sort((a, b) => a - b);
                const mid = Math.floor(sorted.length / 2);
                return sorted.length % 2 ? sorted[mid] : (sorted[mid - 1] + sorted[mid]) / 2;
            },

            async finishSession() {
                if (this.dbReady && this.currentSessionDbId) {
                    try {
                        await ipcRenderer.invoke('db:endSession', this.currentSessionDbId);
                        console.log('‚úÖ Session ended in database');
                    } catch (error) {
                        console.error('Error ending session:', error);
                    }
                }
                
                this.showResults();
            },

            showResults() {
                this.showScreen('resultsScreen');
                
                const summary = document.getElementById('sessionSummary');
                const metricsDisplay = document.getElementById('metricsDisplay');
                const performanceSummary = document.getElementById('performanceSummary');
                
                if (summary && this.currentSession) {
                    const duration = this.calculateDuration(
                        new Date(this.currentSession.startTime),
                        new Date()
                    );
                    summary.innerHTML = `
                        <p><strong>Participant:</strong> ${this.currentSession.participant.id}</p>
                        <p><strong>Session Duration:</strong> ${duration}</p>
                        <p><strong>Tests Completed:</strong> ${this.currentSession.tests ? this.currentSession.tests.length : 0}</p>
                    `;
                }
                
                // Calculate overall metrics
                if (this.currentSession.tests && this.currentSession.tests.length > 0) {
                    let totalTrials = 0;
                    let totalCorrect = 0;
                    let allRTs = [];
                    
                    this.currentSession.tests.forEach(test => {
                        if (test.trials) {
                            totalTrials += test.trials.length;
                            totalCorrect += test.trials.filter(t => t.correct).length;
                            test.trials.forEach(t => {
                                if (t.reactionTime) allRTs.push(t.reactionTime);
                            });
                        }
                    });
                    
                    const avgRT = allRTs.length > 0 ? Math.round(allRTs.reduce((a,b) => a+b, 0) / allRTs.length) : '--';
                    const accuracy = totalTrials > 0 ? Math.round((totalCorrect / totalTrials) * 100) : '--';
                    
                    document.getElementById('avgRT').textContent = avgRT + ' ms';
                    document.getElementById('accuracy').textContent = accuracy + '%';
                    document.getElementById('testsCompleted').textContent = this.currentSession.tests.length;
                    document.getElementById('totalTrials').textContent = totalTrials;
                    
                    // Build detailed performance summary
                    let summaryHTML = '<table style="width: 100%; border-collapse: collapse; margin-top: 15px;">';
                    summaryHTML += '<tr style="border-bottom: 2px solid rgba(255,255,255,0.3);"><th style="text-align: left; padding: 8px;">Test</th><th>Condition</th><th>Trials</th><th>Accuracy</th><th>Mean RT</th></tr>';
                    
                    this.currentSession.tests.forEach(test => {
                        const s = test.summary || {};
                        summaryHTML += `
                            <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                                <td style="padding: 8px;">${test.testType}</td>
                                <td style="text-align: center;">${test.condition}</td>
                                <td style="text-align: center;">${s.totalTrials || '--'}</td>
                                <td style="text-align: center;">${s.accuracy || '--'}%</td>
                                <td style="text-align: center;">${s.meanRT || '--'} ms</td>
                            </tr>
                        `;
                    });
                    
                    summaryHTML += '</table>';
                    performanceSummary.innerHTML = summaryHTML;
                }
            },

            calculateDuration(start, end) {
                const diff = Math.floor((end - start) / 1000);
                const minutes = Math.floor(diff / 60);
                const seconds = diff % 60;
                return `${minutes}m ${seconds}s`;
            },

            async exportResults() {
                if (this.dbReady && this.currentParticipantDbId) {
                    try {
                        const result = await ipcRenderer.invoke('db:exportParticipantData', this.currentParticipantDbId);
                        if (result.success) {
                            this.downloadJson(result.result, `participant_${this.currentParticipantId}_export.json`);
                            return;
                        }
                    } catch (error) {
                        console.error('Database export error:', error);
                    }
                }
                
                const data = {
                    session: this.currentSession,
                    results: this.testResults,
                    exportTime: new Date().toISOString()
                };
                this.downloadJson(data, `session_${this.currentSession.participant.id}_${Date.now()}.json`);
            },

            downloadJson(data, filename) {
                const jsonString = JSON.stringify(data, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                URL.revokeObjectURL(url);
            },

            startNewSession() {
                this.currentSession = null;
                this.currentParticipantId = null;
                this.currentParticipantDbId = null;
                this.currentSessionDbId = null;
                this.selectedTests = [];
                this.testResults = {};
                this.showScreen('welcomeScreen');
            },

            pauseTest() {
                // Pause not fully implemented - just show message
                alert('Test paused. Click OK to continue.');
            },

            skipTest() {
                if (confirm('Are you sure you want to skip this test?')) {
                    this.testIsRunning = false; // This will stop the current test loop
                    this.stopMusic();
                    
                    // Give time for test loop to exit, then proceed
                    setTimeout(() => {
                        this.testIndex++;
                        this.runNextTest();
                    }, 100);
                }
            },

            handleEscape() {
                if (this.currentScreen === 'testScreen') {
                    if (confirm('Exit current test?')) {
                        this.testIsRunning = false;
                        this.stopMusic();
                        
                        setTimeout(() => {
                            this.testIndex++;
                            this.runNextTest();
                        }, 100);
                    }
                }
            }
        };

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', () => {
            app.init();
        });
    </script>
</body>
</html>
