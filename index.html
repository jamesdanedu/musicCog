<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; media-src 'self'">
    <title>Music & Cognition Research Platform</title>
    <style>
        /* ========================================
           BASE STYLES
           ======================================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: #ffffff;
            overflow-x: hidden;
        }

        .screen {
            min-height: 100vh;
            padding: 40px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .screen.hidden {
            display: none;
        }

        .container {
            max-width: 800px;
            width: 100%;
            margin: 0 auto;
        }

        /* ========================================
           TYPOGRAPHY
           ======================================== */
        h1 {
            font-size: 2.5em;
            text-align: center;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        h2 {
            font-size: 1.8em;
            text-align: center;
            margin-bottom: 20px;
        }

        h3 {
            font-size: 1.3em;
            margin-bottom: 10px;
        }

        .subtitle {
            text-align: center;
            font-size: 1.2em;
            color: rgba(255,255,255,0.8);
            margin-bottom: 30px;
        }

        /* ========================================
           BUTTONS
           ======================================== */
        .btn {
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.15);
            color: white;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.25);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .button-group {
            display: flex;
            justify-content: space-between;
            gap: 15px;
            margin-top: 30px;
        }

        /* ========================================
           FORMS
           ======================================== */
        .form-container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 35px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-row-3col {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 6px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.9);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 12px 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            font-size: 1em;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 10px rgba(0, 123, 255, 0.3);
        }

        .form-group select option {
            background: #1a1a2e;
            color: #ffffff;
        }

        .form-group small {
            display: block;
            margin-top: 4px;
            color: #FFD700;
            font-size: 0.85em;
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.9);
        }

        .full-width {
            grid-column: 1 / -1;
        }

        /* ========================================
           INFO BOXES
           ======================================== */
        .info-box {
            background: rgba(255,255,255,0.1);
            padding: 15px 20px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 4px solid #667eea;
        }

        /* ========================================
           PARTICIPANT ID DISPLAY
           ======================================== */
        .participant-id-display {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(102, 126, 234, 0.2);
            border-radius: 10px;
            border: 2px solid #667eea;
        }

        .participant-id-display .label {
            font-size: 0.9em;
            color: rgba(255,255,255,0.7);
            margin-bottom: 5px;
        }

        .participant-id-display .id-value {
            font-size: 1.8em;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            color: #fff;
        }

        /* ========================================
           SUITE SELECTION
           ======================================== */
        .suite-selection {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin: 25px 0;
        }

        .suite-card {
            background: rgba(255, 255, 255, 0.08);
            border: 2px solid rgba(255, 255, 255, 0.15);
            border-radius: 16px;
            padding: 20px 25px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .suite-card:hover {
            background: rgba(255, 255, 255, 0.12);
            border-color: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
        }

        .suite-card.selected {
            background: rgba(102, 126, 234, 0.2);
            border-color: #667eea;
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.3);
        }

        .suite-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 10px;
        }

        .suite-checkbox {
            width: 28px;
            height: 28px;
            border: 2px solid rgba(255, 255, 255, 0.4);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: transparent;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .suite-card.selected .suite-checkbox {
            background: #667eea;
            border-color: #667eea;
            color: white;
        }

        .suite-header h3 {
            flex: 1;
            margin: 0;
            font-size: 1.4em;
        }

        .suite-time {
            background: rgba(255, 255, 255, 0.15);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
        }

        .suite-description {
            color: rgba(255, 255, 255, 0.8);
            margin: 0 0 15px 43px;
            font-size: 0.95em;
        }

        .suite-tests {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-left: 43px;
            margin-bottom: 12px;
        }

        .test-pill {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 14px;
            border-radius: 25px;
            font-size: 0.9em;
        }

        .test-pill .test-duration {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.85em;
        }

        .suite-constructs {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-left: 43px;
        }

        .construct-tag {
            background: rgba(102, 126, 234, 0.3);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8em;
            color: rgba(255, 255, 255, 0.9);
        }

        /* ========================================
           TIME ESTIMATE
           ======================================== */
        .time-estimate {
            background: rgba(74, 222, 128, 0.15);
            border: 1px solid rgba(74, 222, 128, 0.3);
            border-radius: 12px;
            padding: 15px 20px;
            margin: 20px 0;
            text-align: center;
        }

        .time-display {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
        }

        .time-label {
            font-size: 1em;
            color: rgba(255, 255, 255, 0.8);
        }

        .time-value {
            font-size: 1.5em;
            font-weight: 700;
            color: #4ade80;
        }

        .time-breakdown {
            font-size: 0.85em;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 8px;
        }

        /* ========================================
           CONDITIONS INFO
           ======================================== */
        .conditions-info {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 15px 20px;
            margin: 20px 0;
        }

        .conditions-info h4 {
            margin: 0 0 12px 0;
            font-size: 1em;
            color: rgba(255, 255, 255, 0.9);
            text-align: center;
        }

        .condition-list {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .condition-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 20px;
        }

        .condition-icon {
            font-size: 1.2em;
        }

        .condition-type {
            font-size: 0.8em;
            color: rgba(255, 255, 255, 0.5);
        }

        /* ========================================
           TEST EXECUTION SCREEN
           ======================================== */
        .test-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .test-header h2 {
            margin-bottom: 5px;
        }

        .test-condition-label {
            color: #667eea;
            font-size: 1.1em;
        }

        .progress-container {
            width: 100%;
            max-width: 600px;
            margin: 20px auto;
        }

        .progress-bar {
            height: 30px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            transition: width 0.3s ease;
        }

        #testContent {
            width: 100%;
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #testCanvas {
            background: #0f1419;
            border-radius: 10px;
            max-width: 100%;
        }

        /* ========================================
           CONDITION TRANSITION
           ======================================== */
        .condition-transition {
            text-align: center;
            padding: 60px 40px;
        }

        .condition-number {
            font-size: 1.2em;
            color: rgba(255,255,255,0.6);
            margin-bottom: 10px;
        }

        .condition-name {
            font-size: 2.5em;
            margin: 20px 0;
            color: #667eea;
        }

        .condition-instruction {
            font-size: 1.1em;
            color: rgba(255,255,255,0.8);
            margin-bottom: 30px;
        }

        .countdown {
            font-size: 1.5em;
            color: #4ade80;
        }

        /* ========================================
           RESULTS SCREEN
           ======================================== */
        .results-container {
            max-width: 900px;
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 35px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin: 25px 0;
        }

        .metric-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .metric-label {
            font-size: 0.9em;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 8px;
        }

        .metric-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #4ade80;
        }

        .results-section {
            margin: 25px 0;
        }

        .results-section h3 {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        .condition-result {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .cond-name {
            font-weight: 600;
        }

        .cond-stat {
            color: rgba(255,255,255,0.8);
        }

        .test-result-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 6px;
            margin-bottom: 8px;
            font-size: 0.95em;
        }

        .test-result-row .test-name {
            font-weight: 600;
        }

        .test-result-row .test-condition {
            color: rgba(255,255,255,0.6);
        }

        /* ========================================
           ANIMATIONS
           ======================================== */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        /* ========================================
           RESPONSIVE
           ======================================== */
        @media (max-width: 768px) {
            h1 { font-size: 1.8em; }
            
            .form-row,
            .form-row-3col {
                grid-template-columns: 1fr;
            }
            
            .suite-tests,
            .suite-description,
            .suite-constructs {
                margin-left: 0;
            }
            
            .condition-list {
                flex-direction: column;
                align-items: center;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .test-result-row {
                grid-template-columns: 1fr;
                gap: 5px;
            }
        }
    </style>
</head>
<body>

    <!-- ========================================
         WELCOME SCREEN
         ======================================== -->
    <div id="welcomeScreen" class="screen">
        <div class="container">
            <header>
                <h1>üéµ Music & Cognition Research Platform</h1>
                <p class="subtitle">Investigating the Effects of Music on Cognitive Performance</p>
            </header>
            
            <div class="info-box" style="text-align: center; max-width: 600px; margin: 30px auto;">
                <p>Welcome to our research study examining how different types of music affect cognitive performance and reaction time.</p>
                <p style="margin-top: 15px; color: rgba(255,255,255,0.7);">Each session takes approximately 17 minutes to complete.</p>
            </div>

            <div style="text-align: center; margin-top: 40px;">
                <button class="btn btn-primary" onclick="app.showScreen('participantScreen')" style="font-size: 1.2em; padding: 15px 50px;">
                    Begin Session ‚Üí
                </button>
            </div>
        </div>
    </div>

    <!-- ========================================
         PARTICIPANT FORM SCREEN
         ======================================== -->
    <div id="participantScreen" class="screen hidden">
        <div class="container">
            <h2>Participant Information</h2>
            
            <div class="form-container">
                <!-- Auto-generated Participant ID -->
                <div class="participant-id-display">
                    <div class="label">Participant ID (Auto-Generated)</div>
                    <div class="id-value" id="displayParticipantId">P000001</div>
                </div>

                <form id="participantForm">
                    <!-- Row 1: Basic Info -->
                    <div class="form-row-3col">
                        <div class="form-group">
                            <label for="ageCategory">Age Category *</label>
                            <select id="ageCategory" required>
                                <option value="">Select...</option>
                                <option value="10-20">10-20</option>
                                <option value="20-30">20-30</option>
                                <option value="30-40">30-40</option>
                                <option value="40-50">40-50</option>
                                <option value="50+">50+</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="gender">Gender</label>
                            <select id="gender">
                                <option value="">Select...</option>
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                                <option value="non-binary">Non-binary</option>
                                <option value="prefer-not-to-say">Prefer not to say</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="dominantHand">Dominant Hand *</label>
                            <select id="dominantHand" required>
                                <option value="">Select...</option>
                                <option value="right">Right</option>
                                <option value="left">Left</option>
                            </select>
                        </div>
                    </div>

                    <!-- Row 2: Musical Background -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="musicalBackground">Musical Background *</label>
                            <select id="musicalBackground" required>
                                <option value="">Select...</option>
                                <option value="none">No musical training</option>
                                <option value="casual">Casual (self-taught, hobby)</option>
                                <option value="some-lessons">Some lessons (1-3 years)</option>
                                <option value="moderate">Moderate (4-7 years)</option>
                                <option value="extensive">Extensive (8+ years)</option>
                                <option value="professional">Professional musician</option>
                            </select>
                            <small>Formal instruction = lessons with a teacher</small>
                        </div>
                        <div class="form-group">
                            <label for="hearingImpairment">Hearing Impairment *</label>
                            <select id="hearingImpairment" required>
                                <option value="">Select...</option>
                                <option value="none">None</option>
                                <option value="mild">Mild</option>
                                <option value="moderate">Moderate</option>
                                <option value="severe">Severe</option>
                            </select>
                        </div>
                    </div>

                    <!-- Row 3: Additional Info (Optional) -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="caffeineToday">Caffeine Today?</label>
                            <select id="caffeineToday">
                                <option value="none">None</option>
                                <option value="1-cup">1 cup coffee/tea</option>
                                <option value="2-cups">2+ cups coffee/tea</option>
                                <option value="energy-drink">Energy drink</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="sleepHours">Hours of Sleep Last Night</label>
                            <input type="number" id="sleepHours" min="0" max="24" step="0.5" placeholder="e.g., 7.5">
                        </div>
                    </div>

                    <!-- Notes -->
                    <div class="form-group full-width">
                        <label for="notes">Additional Notes (Optional)</label>
                        <textarea id="notes" rows="2" placeholder="Any relevant information..."></textarea>
                    </div>

                    <!-- Buttons -->
                    <div class="button-group">
                        <button type="button" class="btn btn-secondary" onclick="app.showScreen('welcomeScreen')">
                            ‚Üê Back
                        </button>
                        <button type="button" class="btn btn-primary" onclick="app.handleParticipantSubmit()">
                            Continue to Test Selection ‚Üí
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ========================================
         TEST SELECTION SCREEN
         ======================================== -->
    <div id="testSelectionScreen" class="screen hidden">
        <div class="container" style="max-width: 900px;">
            <h2>Select Test Suite</h2>
            
            <div id="sessionInfo" class="info-box"></div>

            <!-- Suite Selection -->
            <div class="suite-selection">
                
                <!-- Suite 1: Reaction & Inhibition -->
                <div class="suite-card selected" data-suite="reaction-inhibition" onclick="app.toggleSuite(this)">
                    <div class="suite-header">
                        <div class="suite-checkbox">‚úì</div>
                        <h3>‚ö° Reaction & Inhibition</h3>
                        <span class="suite-time">~17 min</span>
                    </div>
                    <p class="suite-description">Processing speed, response inhibition, and selective attention</p>
                    <div class="suite-tests">
                        <div class="test-pill">
                            <span>üéØ Simple Reaction Time</span>
                            <span class="test-duration">1 min</span>
                        </div>
                        <div class="test-pill">
                            <span>üö¶ Go/No-Go Task</span>
                            <span class="test-duration">1.5 min</span>
                        </div>
                        <div class="test-pill">
                            <span>üåà Stroop Test</span>
                            <span class="test-duration">1.5 min</span>
                        </div>
                    </div>
                    <div class="suite-constructs">
                        <span class="construct-tag">Processing Speed</span>
                        <span class="construct-tag">Response Inhibition</span>
                        <span class="construct-tag">Cognitive Control</span>
                    </div>
                </div>

                <!-- Suite 2: Cognitive Load -->
                <div class="suite-card" data-suite="cognitive-load" onclick="app.toggleSuite(this)">
                    <div class="suite-header">
                        <div class="suite-checkbox"></div>
                        <h3>üß† Cognitive Load</h3>
                        <span class="suite-time">~17 min</span>
                    </div>
                    <p class="suite-description">Decision making, working memory capacity, and memory updating</p>
                    <div class="suite-tests">
                        <div class="test-pill">
                            <span>üéØ Choice Reaction Time</span>
                            <span class="test-duration">1.5 min</span>
                        </div>
                        <div class="test-pill">
                            <span>üî¢ Digit Span</span>
                            <span class="test-duration">2 min</span>
                        </div>
                        <div class="test-pill">
                            <span>üîÑ N-Back (2-Back)</span>
                            <span class="test-duration">2 min</span>
                        </div>
                    </div>
                    <div class="suite-constructs">
                        <span class="construct-tag">Decision Speed</span>
                        <span class="construct-tag">Working Memory</span>
                        <span class="construct-tag">Memory Updating</span>
                    </div>
                </div>
            </div>

            <!-- Time Estimate -->
            <div class="time-estimate">
                <div class="time-display">
                    <span class="time-label">Estimated Session Time:</span>
                    <span class="time-value" id="estimatedTime">~17 minutes</span>
                </div>
                <div class="time-breakdown" id="timeBreakdown">
                    3 tests √ó 3 music conditions + transitions
                </div>
            </div>

            <!-- Music Conditions Info -->
            <div class="conditions-info">
                <h4>Music Conditions (each subject tested under all 3)</h4>
                <div class="condition-list">
                    <div class="condition-item">
                        <span class="condition-icon">üîá</span>
                        <span>Silence</span>
                        <span class="condition-type">Control</span>
                    </div>
                    <div class="condition-item">
                        <span class="condition-icon">üéª</span>
                        <span>80 BPM Classical</span>
                        <span class="condition-type">Low tempo</span>
                    </div>
                    <div class="condition-item">
                        <span class="condition-icon">üéß</span>
                        <span>140 BPM Electronic</span>
                        <span class="condition-type">High tempo</span>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="button-group">
                <button class="btn btn-secondary" onclick="app.showScreen('participantScreen')">
                    ‚Üê Back
                </button>
                <button class="btn btn-primary" id="startTestingBtn" onclick="app.startTesting()">
                    Start Testing ‚Üí
                </button>
            </div>
        </div>
    </div>

    <!-- ========================================
         TEST EXECUTION SCREEN
         ======================================== -->
    <div id="testScreen" class="screen hidden">
        <div class="container" style="max-width: 900px; text-align: center;">
            <div class="test-header">
                <h2 id="testTitle">Test in Progress</h2>
                <div class="test-condition-label" id="currentTestName"></div>
            </div>
            
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%;">0%</div>
                </div>
            </div>

            <div id="testContent">
                <canvas id="testCanvas" width="800" height="500"></canvas>
            </div>

            <div class="info-box" id="testInstructions" style="max-width: 600px; margin: 20px auto;">
                Test instructions will appear here
            </div>

            <div class="button-group" style="justify-content: center;">
                <button class="btn btn-secondary" onclick="app.skipTest()">
                    Skip Test
                </button>
            </div>
        </div>
    </div>

    <!-- ========================================
         RESULTS SCREEN
         ======================================== -->
    <div id="resultsScreen" class="screen hidden">
        <div class="results-container">
            <h2 style="text-align: center; margin-bottom: 25px;">Session Complete! üéâ</h2>
            
            <div id="sessionSummary" class="info-box"></div>

            <div class="metric-grid" id="metricsDisplay">
                <div class="metric-card">
                    <div class="metric-label">Avg Reaction Time</div>
                    <div class="metric-value" id="avgRT">--</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Accuracy</div>
                    <div class="metric-value" id="avgAccuracy">--</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Tests Completed</div>
                    <div class="metric-value" id="testsCompleted">--</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Conditions</div>
                    <div class="metric-value" id="conditionsCompleted">3</div>
                </div>
            </div>

            <div id="performanceSummary" class="results-section">
                <!-- Populated by JavaScript -->
            </div>

            <div class="button-group" style="justify-content: center;">
                <button class="btn btn-secondary" onclick="app.exportResults()">
                    üì• Export Data
                </button>
                <button class="btn btn-primary" onclick="app.startNewSession()">
                    Start New Session ‚Üí
                </button>
            </div>
        </div>
    </div>

    <!-- ========================================
         SCRIPTS
         ======================================== -->
    
    <!-- Configuration -->
    <script src="js/config/test-suites.js"></script>
    
    <!-- Core Systems -->
    <script src="js/core/music-analyzer.js"></script>
    <script src="js/core/metrics-collector.js"></script>
    <script src="js/core/data-logger.js"></script>
    
    <!-- Test Base Class -->
    <script src="js/tests/test-base.js"></script>
    
    <!-- Individual Tests - Suite 1 -->
    <script src="js/tests/simple-reaction.js"></script>
    <script src="js/tests/go-nogo.js"></script>
    <script src="js/tests/stroop.js"></script>
    
    <!-- Individual Tests - Suite 2 -->
    <script src="js/tests/choice-reaction.js"></script>
    <script src="js/tests/digit-span.js"></script>
    <script src="js/tests/n-back.js"></script>
    
    <!-- Session Controller -->
    <script src="js/session-controller.js"></script>
    
    <!-- Platform (if using Electron) -->
    <script src="js/platform.js"></script>

    <!-- Main Application -->
    <script>
        // ========================================
        // MAIN APPLICATION
        // ========================================
        const app = {
            currentScreen: 'welcomeScreen',
            currentSession: null,
            sessionController: null,
            participantCounter: 1,
            canvas: null,
            ctx: null,

            // ----------------------------------------
            // INITIALIZATION
            // ----------------------------------------
            init() {
                console.log('Initializing Music & Cognition Research Platform...');
                
                this.canvas = document.getElementById('testCanvas');
                if (this.canvas) {
                    this.ctx = this.canvas.getContext('2d');
                }
                
                this.loadParticipantCounter();
                this.setupKeyboardShortcuts();
                
                // Initialize session controller if available
                if (typeof SessionController !== 'undefined') {
                    this.sessionController = new SessionController(this);
                }
                
                console.log('Platform initialized');
            },

            loadParticipantCounter() {
                const saved = localStorage.getItem('lastParticipantNumber');
                if (saved) {
                    this.participantCounter = parseInt(saved) + 1;
                } else {
                    this.participantCounter = 1;
                }
            },

            generateParticipantId() {
                const id = 'P' + String(this.participantCounter).padStart(6, '0');
                localStorage.setItem('lastParticipantNumber', this.participantCounter);
                this.participantCounter++;
                return id;
            },

            setupKeyboardShortcuts() {
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && this.currentScreen === 'testScreen') {
                        if (confirm('Exit current test?')) {
                            this.skipTest();
                        }
                    }
                });
            },

            // ----------------------------------------
            // SCREEN MANAGEMENT
            // ----------------------------------------
            showScreen(screenId) {
                document.querySelectorAll('.screen').forEach(screen => {
                    screen.classList.add('hidden');
                });
                
                const targetScreen = document.getElementById(screenId);
                if (targetScreen) {
                    targetScreen.classList.remove('hidden');
                    targetScreen.classList.add('fade-in');
                    this.currentScreen = screenId;
                    
                    // Screen-specific initialization
                    if (screenId === 'participantScreen') {
                        const participantId = this.generateParticipantId();
                        const displayElement = document.getElementById('displayParticipantId');
                        if (displayElement) {
                            displayElement.textContent = participantId;
                        }
                        this.currentParticipantId = participantId;
                    }
                    
                    if (screenId === 'testSelectionScreen') {
                        this.updateTimeEstimate();
                    }
                }
            },

            // ----------------------------------------
            // PARTICIPANT FORM
            // ----------------------------------------
            handleParticipantSubmit() {
                // Validate required fields
                const ageCategory = document.getElementById('ageCategory').value;
                const dominantHand = document.getElementById('dominantHand').value;
                const musicalBackground = document.getElementById('musicalBackground').value;
                const hearingImpairment = document.getElementById('hearingImpairment').value;
                
                if (!ageCategory || !dominantHand || !musicalBackground || !hearingImpairment) {
                    alert('Please fill in all required fields marked with *');
                    return;
                }
                
                // Create session
                this.currentSession = {
                    id: 'SESSION_' + Date.now(),
                    participant: {
                        id: this.currentParticipantId,
                        ageCategory: ageCategory,
                        gender: document.getElementById('gender').value || 'not-specified',
                        dominantHand: dominantHand,
                        musicalBackground: musicalBackground,
                        hearingImpairment: hearingImpairment,
                        caffeineToday: document.getElementById('caffeineToday').value || 'none',
                        sleepHours: parseFloat(document.getElementById('sleepHours').value) || null,
                        notes: document.getElementById('notes').value || ''
                    },
                    startTime: new Date().toISOString(),
                    results: []
                };
                
                this.displaySessionInfo();
                this.showScreen('testSelectionScreen');
            },

            displaySessionInfo() {
                const info = document.getElementById('sessionInfo');
                if (info && this.currentSession) {
                    const p = this.currentSession.participant;
                    info.innerHTML = `
                        <strong>Participant:</strong> ${p.id} | 
                        <strong>Age:</strong> ${p.ageCategory} | 
                        <strong>Hand:</strong> ${p.dominantHand} | 
                        <strong>Musical Background:</strong> ${p.musicalBackground}
                    `;
                }
            },

            // ----------------------------------------
            // SUITE SELECTION
            // ----------------------------------------
            toggleSuite(cardElement) {
                const selectedCards = document.querySelectorAll('.suite-card.selected');
                
                if (cardElement.classList.contains('selected')) {
                    // Don't allow deselecting if it's the only one
                    if (selectedCards.length <= 1) {
                        alert('At least one test suite must be selected');
                        return;
                    }
                    cardElement.classList.remove('selected');
                    cardElement.querySelector('.suite-checkbox').textContent = '';
                } else {
                    cardElement.classList.add('selected');
                    cardElement.querySelector('.suite-checkbox').textContent = '‚úì';
                }
                
                this.updateTimeEstimate();
            },

            updateTimeEstimate() {
                const selectedCards = document.querySelectorAll('.suite-card.selected');
                const numSuites = selectedCards.length;
                
                // Calculate time
                let testsPerCondition = numSuites * 3; // 3 tests per suite
                let minutes = numSuites === 1 ? 17 : 34;
                
                const timeValue = document.getElementById('estimatedTime');
                const timeBreakdown = document.getElementById('timeBreakdown');
                
                if (timeValue) {
                    timeValue.textContent = `~${minutes} minutes`;
                    timeValue.style.color = minutes <= 20 ? '#4ade80' : '#fbbf24';
                }
                
                if (timeBreakdown) {
                    timeBreakdown.textContent = `${testsPerCondition} tests √ó 3 music conditions + transitions`;
                }
            },

            // ----------------------------------------
            // TEST EXECUTION
            // ----------------------------------------
            startTesting() {
                // Get selected suites
                const selectedCards = document.querySelectorAll('.suite-card.selected');
                const selectedSuites = Array.from(selectedCards).map(card => card.dataset.suite);
                
                if (selectedSuites.length === 0) {
                    alert('Please select at least one test suite');
                    return;
                }
                
                // Use session controller if available
                if (this.sessionController) {
                    this.sessionController.selectedSuites = selectedSuites;
                    this.sessionController.currentSession = this.currentSession;
                    this.sessionController.startTesting();
                } else {
                    // Fallback: simple test execution
                    this.runSimpleTestFlow(selectedSuites);
                }
            },

            runSimpleTestFlow(selectedSuites) {
                // Simplified fallback if session controller not loaded
                this.showScreen('testScreen');
                document.getElementById('testTitle').textContent = 'Tests Starting...';
                document.getElementById('testInstructions').textContent = 
                    'The session controller is not loaded. Please check script includes.';
            },

            skipTest() {
                if (this.sessionController) {
                    this.sessionController.currentTestIndex++;
                    this.sessionController.startNextCondition();
                }
            },

            // ----------------------------------------
            // RESULTS
            // ----------------------------------------
            showResults() {
                this.showScreen('resultsScreen');
                
                if (this.currentSession && this.currentSession.results) {
                    const results = this.currentSession.results;
                    
                    // Calculate aggregates
                    const rts = results.filter(r => r.metrics && r.metrics.meanRT).map(r => r.metrics.meanRT);
                    const accs = results.filter(r => r.metrics && r.metrics.accuracy).map(r => parseFloat(r.metrics.accuracy));
                    
                    const avgRT = rts.length > 0 ? Math.round(rts.reduce((a,b) => a+b) / rts.length) : '--';
                    const avgAcc = accs.length > 0 ? (accs.reduce((a,b) => a+b) / accs.length).toFixed(1) : '--';
                    
                    document.getElementById('avgRT').textContent = avgRT + (avgRT !== '--' ? ' ms' : '');
                    document.getElementById('avgAccuracy').textContent = avgAcc + (avgAcc !== '--' ? '%' : '');
                    document.getElementById('testsCompleted').textContent = results.length;
                    
                    // Session summary
                    const summary = document.getElementById('sessionSummary');
                    if (summary) {
                        const duration = this.calculateDuration();
                        summary.innerHTML = `
                            <strong>Participant:</strong> ${this.currentSession.participant.id}<br>
                            <strong>Session Duration:</strong> ${duration}<br>
                            <strong>Suites Completed:</strong> ${this.sessionController ? this.sessionController.selectedSuites.length : 1}
                        `;
                    }
                }
            },

            calculateDuration() {
                if (!this.currentSession || !this.currentSession.startTime) return '--';
                const start = new Date(this.currentSession.startTime);
                const now = new Date();
                const diff = Math.floor((now - start) / 1000);
                const minutes = Math.floor(diff / 60);
                const seconds = diff % 60;
                return `${minutes}m ${seconds}s`;
            },

            exportResults() {
                const data = {
                    session: this.currentSession,
                    exportTime: new Date().toISOString()
                };
                
                const jsonString = JSON.stringify(data, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `session_${this.currentSession.participant.id}_${Date.now()}.json`;
                a.click();
                URL.revokeObjectURL(url);
            },

            startNewSession() {
                this.currentSession = null;
                if (this.sessionController) {
                    this.sessionController.currentSession = null;
                    this.sessionController.testQueue = [];
                    this.sessionController.currentTestIndex = 0;
                }
                this.showScreen('welcomeScreen');
            },

            // ----------------------------------------
            // AUDIO (Placeholder methods)
            // ----------------------------------------
            async stopAudio() {
                // Implement based on your audio system
                console.log('Stopping audio...');
            },

            async loadAudio(filePath) {
                console.log('Loading audio:', filePath);
            },

            async generateWhiteNoise() {
                console.log('Generating white noise...');
            }
        };

        // ----------------------------------------
        // INITIALIZE ON LOAD
        // ----------------------------------------
        window.addEventListener('DOMContentLoaded', () => {
            app.init();
        });
    </script>

</body>
</html>
